<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºåŠŸèƒ½å‰ç«¯ - åŠ¨æ€é€šè®¯å½•</title>
    <style>
        /* ===== å‘½åç©ºé—´éš”ç¦» - ä½¿ç”¨pf-å‰ç¼€ ===== */
        .pf-floating-ball {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(103, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .pf-floating-ball:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(103, 126, 234, 0.4);
        }

        .pf-floating-ball-icon {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .pf-phone-container {
            position: fixed;
            bottom: 200px;
            right: 20px;
            width: 360px;
            height: 600px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .pf-phone-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pf-phone-title {
            font-size: 18px;
            font-weight: 600;
        }

        .pf-phone-close, .pf-phone-sync {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .pf-phone-close:hover, .pf-phone-sync:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .pf-phone-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.05);
            padding: 4px;
            margin: 0 20px;
            border-radius: 12px;
        }

        .pf-tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pf-tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pf-tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .pf-tab-content.active {
            display: block;
        }

        /* åœ°å›¾æ ·å¼ */
        .pf-map-container {
            font-family: 'Arial', sans-serif;
        }

        .pf-location-item {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
            line-height: 1.4;
        }

        .pf-location-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #667eea;
        }

        .pf-location-item.main {
            font-weight: bold;
            color: #333;
            margin-top: 12px;
            padding-left: 0;
        }

        .pf-location-item.main::before {
            display: none;
        }

        .pf-location-item.sub {
            color: #666;
            padding-left: 24px;
        }

        .pf-location-item.subsub {
            color: #888;
            padding-left: 40px;
            font-size: 14px;
        }

        /* é€šè®¯å½•æ ·å¼ */
        .pf-contact-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pf-contact-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .pf-contact-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.2);
            transform: translateX(4px);
        }

        .pf-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
            font-size: 18px;
        }

        .pf-contact-info {
            flex: 1;
        }

        .pf-contact-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .pf-contact-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .pf-contact-stats {
            font-size: 11px;
            margin-top: 4px;
            color: #888;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pf-stat-item {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .pf-contact-actions {
            display: flex;
            gap: 8px;
        }

        .pf-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .pf-action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        /* çŸ­ä¿¡æ ·å¼ */
        .pf-message-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .pf-message-selector {
            margin-bottom: 16px;
        }

        .pf-message-selector select {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            font-size: 14px;
            color: #333;
        }

        .pf-message-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            min-height: 200px;
        }

        .pf-message-input {
            display: flex;
            gap: 8px;
        }

        .pf-message-input textarea {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            resize: none;
            font-size: 14px;
            min-height: 60px;
            font-family: inherit;
        }

        .pf-send-btn {
            align-self: flex-end;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .pf-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .pf-message-bubble {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .pf-message-sent {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .pf-message-received {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }

        .pf-message-system {
            background: rgba(255, 193, 7, 0.1);
            color: #666;
            font-style: italic;
            max-width: 100%;
            text-align: center;
        }

        .pf-message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        /* é€šçŸ¥æ ·å¼ */
        .pf-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            animation: pf-slideIn 0.3s ease-out;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .pf-phone-container {
                width: calc(100vw - 40px);
                height: 70vh;
                right: 20px;
                left: 20px;
            }
            
            .pf-floating-ball {
                bottom: 80px;
                right: 20px;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pf-slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pf-notificationIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pf-notificationOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .pf-phone-container.show {
            display: flex;
            animation: pf-slideIn 0.3s ease-out;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .pf-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .pf-status-online {
            background: #4caf50;
        }

        .pf-status-offline {
            background: #9e9e9e;
        }

        .pf-status-busy {
            background: #f44336;
        }
    </style>
</head>
<body>
<!-- æ‚¬æµ®çƒ -->
<div class="pf-floating-ball" id="pfFloatingBall" title="æ‰“å¼€æ‰‹æœºåŠŸèƒ½">
    <div class="pf-floating-ball-icon">ğŸ“±</div>
</div>

<!-- æ‰‹æœºåŠŸèƒ½ç•Œé¢ -->
<div class="pf-phone-container" id="pfPhoneContainer">
    <div class="pf-phone-header">
        <div class="pf-phone-title">æ‰‹æœºåŠŸèƒ½</div>
        <div style="display: flex; gap: 8px;">
            <button class="pf-phone-sync" id="pfSyncBtn" title="åŒæ­¥è”ç³»äºº">ğŸ”„</button>
            <button class="pf-phone-close" id="pfCloseBtn" title="å…³é—­">Ã—</button>
        </div>
    </div>
    
    <!-- é€‰é¡¹å¡ -->
    <div class="pf-phone-tabs">
        <button class="pf-tab-btn active" data-tab="map" title="æŸ¥çœ‹åœ°å›¾">ğŸ—ºï¸ åœ°å›¾</button>
        <button class="pf-tab-btn" data-tab="contacts" title="æŸ¥çœ‹é€šè®¯å½•">ğŸ‘¥ é€šè®¯å½•</button>
        <button class="pf-tab-btn" data-tab="messages" title="å‘é€çŸ­ä¿¡">ğŸ’¬ çŸ­ä¿¡</button>
    </div>
    
    <!-- åœ°å›¾é€‰é¡¹å¡ -->
    <div class="pf-tab-content active" id="pfTabMap">
        <div class="pf-map-container">
            <div class="pf-location-item main">ä¸œäº¬æ•´ä½“ä½ç½®å…³ç³»</div>
            <div class="pf-location-item main">è¥¿åŒ—æ–¹å‘</div>
            <div class="pf-location-item sub">â”œâ”€ æ‰å¹¶åŒºï¼ˆæ•…äº‹ä¸»è¦èˆå°ï¼‰</div>
            <div class="pf-location-item subsub">â”‚   â”œâ”€ é«˜å††å¯ºï¼ˆä¸»è§’ã€ä¼Šè‰é›…ã€ç¾æ¸¸ã€å…‹æ´›ä¼Šã€å­¦æ ¡ï¼‰</div>
            <div class="pf-location-item subsub">â”‚   â”œâ”€ é˜¿ä½è°·ï¼ˆçŠ¬å†¢å¤ç¾ï¼‰</div>
            <div class="pf-location-item subsub">â”‚   â””â”€ è»æ´¼ï¼ˆå‘¨è¾¹å•†ä¸šåŒºï¼‰</div>
            <div class="pf-location-item sub">â”œâ”€ ä¸­é‡åŒºï¼ˆé˜¿å®…å›ï¼‰</div>
            <div class="pf-location-item sub">â”œâ”€ æ–°å®¿åŒºï¼ˆç¹åå•†ä¸šåŒºï¼Œè½¬è½¦æ¢çº½ï¼‰</div>
            <div class="pf-location-item sub">â”œâ”€ æ–‡äº¬åŒºï¼ˆæœˆå’æ·±é›ªï¼‰</div>
            <div class="pf-location-item sub">â””â”€ æ¸¯åŒºï¼ˆè¥¿å›­å¯ºçˆ±ä¸½èï¼‰</div>
            
            <!-- äº¤äº’æŒ‰é’® -->
            <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button class="pf-action-btn" id="pfSearchLocation" title="æœç´¢ä½ç½®">
                    <span style="font-size: 20px;">ğŸ”</span>
                </button>
                <button class="pf-action-btn" id="pfGetDirections" title="è·å–è·¯çº¿">
                    <span style="font-size: 20px;">ğŸ“</span>
                </button>
                <button class="pf-action-btn" id="pfCurrentLocation" title="å½“å‰ä½ç½®">
                    <span style="font-size: 20px;">ğŸ“</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- é€šè®¯å½•é€‰é¡¹å¡ -->
    <div class="pf-tab-content" id="pfTabContacts">
        <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 14px; color: #666;">
                å…± <span id="pfContactCount">0</span> ä¸ªè”ç³»äºº
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="pf-action-btn" id="pfRefreshContacts" title="åˆ·æ–°" style="font-size: 16px;">ğŸ”„</button>
                <button class="pf-action-btn" id="pfAddContact" title="æ·»åŠ è”ç³»äºº" style="font-size: 16px;">â•</button>
            </div>
        </div>
        
        <div class="pf-contact-list" id="pfContactList">
            <!-- é€šè®¯å½•å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div style="text-align: center; color: #999; padding: 40px 0;">
                æ­£åœ¨åŠ è½½è”ç³»äºº...
            </div>
        </div>
    </div>
    
    <!-- çŸ­ä¿¡é€‰é¡¹å¡ -->
    <div class="pf-tab-content" id="pfTabMessages">
        <div class="pf-message-container">
            <div class="pf-message-selector">
                <select id="pfMessageTo">
                    <option value="">é€‰æ‹©è”ç³»äºº...</option>
                </select>
            </div>
            
            <div class="pf-message-history" id="pfMessageHistory">
                <!-- æ¶ˆæ¯å†å²å°†åŠ¨æ€æ˜¾ç¤º -->
                <div style="text-align: center; color: #999; padding: 40px 0;">
                    é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©
                </div>
            </div>
            
            <div class="pf-message-input">
                <textarea id="pfMessageInput" placeholder="è¾“å…¥çŸ­ä¿¡å†…å®¹..."></textarea>
                <button class="pf-send-btn" id="pfSendMessage">å‘é€</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== å‘½åç©ºé—´éš”ç¦» - ä½¿ç”¨pfå‘½åç©ºé—´ =====
class PhoneFunctions {
    constructor() {
        this.isOpen = false;
        this.currentTab = 'map';
        this.contacts = []; // åŠ¨æ€ç”Ÿæˆ
        this.messages = {};
        this.mvuData = null;
        this.messageListeners = [];
        this.currentChatContact = null;
        
        // ç«‹å³åˆå§‹åŒ–
        this.init().catch(error => {
            console.error('PhoneFunctionsåˆå§‹åŒ–å¤±è´¥:', error);
            this.showNotification('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
        });
    }
    
    async init() {
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
        
        // è®¾ç½®MVUç›‘å¬å™¨
        this.setupMvuListener();
        
        // åŠ è½½MVUæ•°æ®å¹¶ç”Ÿæˆé€šè®¯å½•
        await this.loadMvuData();
        
        // åŠ è½½æ¶ˆæ¯å†å²
        this.loadMessageHistory();
        
        console.log('æ‰‹æœºåŠŸèƒ½å‰ç«¯åˆå§‹åŒ–å®Œæˆ');
        this.showNotification('æ‰‹æœºåŠŸèƒ½å·²åŠ è½½', 'info');
    }
    
    bindEvents() {
        // æ‚¬æµ®çƒç‚¹å‡»
        document.getElementById('pfFloatingBall').addEventListener('click', (e) => {
            this.togglePhone();
            e.stopPropagation();
        });
        
        // å…³é—­æŒ‰é’®
        document.getElementById('pfCloseBtn').addEventListener('click', (e) => {
            this.closePhone();
            e.stopPropagation();
        });
        
        // åŒæ­¥æŒ‰é’®
        document.getElementById('pfSyncBtn').addEventListener('click', async (e) => {
            e.stopPropagation();
            await this.syncContactsFromMvu();
        });
        
        // åˆ·æ–°è”ç³»äººæŒ‰é’®
        document.getElementById('pfRefreshContacts').addEventListener('click', async (e) => {
            e.stopPropagation();
            await this.syncContactsFromMvu();
        });
        
        // æ·»åŠ è”ç³»äººæŒ‰é’®
        document.getElementById('pfAddContact').addEventListener('click', (e) => {
            e.stopPropagation();
            this.promptAddContact();
        });
        
        // é€‰é¡¹å¡åˆ‡æ¢
        document.querySelectorAll('.pf-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                this.switchTab(tab);
            });
        });
        
        // åœ°å›¾åŠŸèƒ½æŒ‰é’®
        document.getElementById('pfSearchLocation').addEventListener('click', () => {
            this.sendMessageToAI('æœç´¢å½“å‰ä½ç½®é™„è¿‘çš„åœ°ç‚¹');
        });
        
        document.getElementById('pfGetDirections').addEventListener('click', () => {
            this.sendMessageToAI('è·å–ä»å½“å‰ä½ç½®åˆ°ç›®çš„åœ°çš„è·¯çº¿');
        });
        
        document.getElementById('pfCurrentLocation').addEventListener('click', () => {
            this.sendMessageToAI('å‘Šè¯‰æˆ‘ç°åœ¨åœ¨å“ªé‡Œï¼Œå‘¨å›´æœ‰ä»€ä¹ˆ');
        });
        
        // å‘é€çŸ­ä¿¡
        document.getElementById('pfSendMessage').addEventListener('click', () => {
            this.sendMessage();
        });
        
        // çŸ­ä¿¡è¾“å…¥æ¡†å›è½¦å‘é€
        document.getElementById('pfMessageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // è”ç³»äººé€‰æ‹©å˜åŒ–
        document.getElementById('pfMessageTo').addEventListener('change', (e) => {
            const contactId = e.target.value;
            if (contactId) {
                const contact = this.contacts.find(c => c.id === contactId);
                if (contact) {
                    this.currentChatContact = contact;
                    this.loadChatHistory(contactId);
                }
            } else {
                this.currentChatContact = null;
                this.clearChatHistory();
            }
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', (e) => {
            const phoneContainer = document.getElementById('pfPhoneContainer');
            const floatingBall = document.getElementById('pfFloatingBall');
            
            if (this.isOpen && 
                !phoneContainer.contains(e.target) && 
                !floatingBall.contains(e.target)) {
                this.closePhone();
            }
        });
    }
    
    togglePhone() {
        const container = document.getElementById('pfPhoneContainer');
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            container.classList.add('show');
            // åˆ·æ–°æ•°æ®
            this.updateContactList();
            this.updateMessageContacts();
            // æ›´æ–°è”ç³»äººæ•°é‡
            document.getElementById('pfContactCount').textContent = this.contacts.length;
        } else {
            container.classList.remove('show');
        }
    }
    
    closePhone() {
        this.isOpen = false;
        document.getElementById('pfPhoneContainer').classList.remove('show');
    }
    
    switchTab(tab) {
        this.currentTab = tab;
        
        // æ›´æ–°é€‰é¡¹å¡æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.pf-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        
        // æ›´æ–°é€‰é¡¹å¡å†…å®¹
        document.querySelectorAll('.pf-tab-content').forEach(content => {
            const tabName = content.id.replace('pfTab', '');
            content.classList.toggle('active', tabName.toLowerCase() === tab);
        });
        
        // åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”æ•°æ®
        if (tab === 'contacts') {
            this.updateContactList();
        } else if (tab === 'messages') {
            this.updateMessageContacts();
        }
    }
    
    // ===== MVUå˜é‡ç³»ç»Ÿé›†æˆ =====
    async loadMvuData() {
        try {
            console.log('å¼€å§‹åŠ è½½MVUæ•°æ®...');
            
            // æ–¹æ³•1ï¼šä½¿ç”¨MVUæ¡†æ¶API
            if (typeof window.Mvu !== 'undefined') {
                console.log('ä½¿ç”¨MVUæ¡†æ¶API');
                const mvuData = await this.getMvuDataFromFramework();
                if (mvuData) {
                    this.mvuData = mvuData;
                    this.generateContactsFromMvu();
                    return;
                }
            }
            
            // æ–¹æ³•2ï¼šä½¿ç”¨é…’é¦†åŠ©æ‰‹å˜é‡API
            console.log('å°è¯•ä½¿ç”¨é…’é¦†åŠ©æ‰‹å˜é‡API');
            const variables = await this.getVariablesFromTavernHelper();
            if (variables) {
                this.mvuData = { stat_data: variables };
                this.generateContactsFromMvu();
                return;
            }
            
            // æ–¹æ³•3ï¼šå¤‡ç”¨æ–¹æ¡ˆ
            console.log('ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆåŠ è½½æ•°æ®');
            this.loadFallbackContacts();
            
        } catch (error) {
            console.error('åŠ è½½MVUæ•°æ®å¤±è´¥:', error);
            this.loadFallbackContacts();
            this.showNotification('æ— æ³•åŠ è½½å˜é‡æ•°æ®ï¼Œä½¿ç”¨å¤‡ç”¨é€šè®¯å½•', 'warning');
        }
    }
    
    async getMvuDataFromFramework() {
        try {
            // å°è¯•ç­‰å¾…MVUæ¡†æ¶åˆå§‹åŒ–
            if (typeof window.TavernHelper !== 'undefined') {
                await window.TavernHelper.waitGlobalInitialized('Mvu');
            }
            
            // ä½¿ç”¨MVU APIè·å–æ•°æ®
            if (typeof window.Mvu !== 'undefined' && window.Mvu.getMvuData) {
                const data = window.Mvu.getMvuData({ type: 'chat' });
                console.log('ä»MVUæ¡†æ¶è·å–åˆ°æ•°æ®:', data);
                return data;
            }
            
            return null;
        } catch (error) {
            console.warn('MVUæ¡†æ¶è·å–å¤±è´¥:', error);
            return null;
        }
    }
    
    async getVariablesFromTavernHelper() {
        try {
            // ä½¿ç”¨é…’é¦†åŠ©æ‰‹å˜é‡API
            if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.getVariables) {
                const variables = window.TavernHelper.getVariables({ type: 'chat' });
                console.log('ä»é…’é¦†åŠ©æ‰‹è·å–åˆ°å˜é‡:', variables);
                return variables;
            }
            
            return null;
        } catch (error) {
            console.warn('é…’é¦†åŠ©æ‰‹å˜é‡è·å–å¤±è´¥:', error);
            return null;
        }
    }
    
    /**
     * æ ¸å¿ƒåŠŸèƒ½ï¼šä»MVUå˜é‡ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆé€šè®¯å½•
     * è‡ªåŠ¨è¯†åˆ«stat_data.è§’è‰²ä¸‹çš„æ‰€æœ‰è§’è‰²
     */
    generateContactsFromMvu() {
        console.log('å¼€å§‹ä»MVUç”Ÿæˆé€šè®¯å½•...');
        console.log('MVUæ•°æ®:', this.mvuData);
        
        if (!this.mvuData?.stat_data?.è§’è‰²) {
            console.warn('æœªæ‰¾åˆ°è§’è‰²æ•°æ®ï¼Œä½¿ç”¨å¤‡ç”¨é€šè®¯å½•');
            this.loadFallbackContacts();
            return;
        }
        
        const roles = this.mvuData.stat_data.è§’è‰²;
        console.log('æ‰¾åˆ°è§’è‰²:', Object.keys(roles));
        
        this.contacts = [];
        
        // éå†æ‰€æœ‰è§’è‰²
        Object.entries(roles).forEach(([roleName, roleData], index) => {
            // è·³è¿‡éå¯¹è±¡ç±»å‹çš„è§’è‰²æ•°æ®
            if (typeof roleData !== 'object' || roleData === null) {
                return;
            }
            
            // ç”Ÿæˆè”ç³»äººID
            const contactId = this.generateContactId(roleName, index);
            
            // ç”Ÿæˆè”ç³»äººä¿¡æ¯
            const contact = {
                id: contactId,
                name: roleName,
                desc: this.generateRoleDescription(roleName, roleData),
                avatar: this.getAvatarInitial(roleName),
                phone: this.generatePhoneNumber(index),
                status: this.generateStatus(roleData),
                lastContact: this.generateLastContactTime(),
                mvuData: { ...roleData } // ä¿å­˜å®Œæ•´çš„MVUæ•°æ®
            };
            
            // ç¡®ä¿åŸºç¡€å±æ€§å­˜åœ¨
            if (!contact.mvuData.å¥½æ„Ÿåº¦) contact.mvuData.å¥½æ„Ÿåº¦ = 0;
            if (!contact.mvuData.è­¦æˆ’åº¦) contact.mvuData.è­¦æˆ’åº¦ = 0;
            if (!contact.mvuData.æœä»åº¦) contact.mvuData.æœä»åº¦ = 0;
            if (!contact.mvuData.æ€§æ¬²) contact.mvuData.æ€§æ¬² = 0;
            
            console.log(`æ·»åŠ è”ç³»äºº: ${roleName} (ID: ${contactId})`);
            this.contacts.push(contact);
        });
        
        console.log(`ä»MVUå˜é‡ç³»ç»Ÿç”Ÿæˆäº†${this.contacts.length}ä¸ªè”ç³»äºº`);
        
        // æ·»åŠ ç³»ç»Ÿè”ç³»äºº
        this.addSystemContacts();
        
        // å¦‚æœæœ‰ç‰¹æ®Šè§’è‰²éœ€è¦é¢å¤–å¤„ç†
        this.addSpecialContacts();
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateContactList();
        this.updateMessageContacts();
        
        // æ˜¾ç¤ºé€šçŸ¥
        if (this.contacts.length > 0) {
            this.showNotification(`å·²åŠ è½½${this.contacts.length}ä¸ªè”ç³»äºº`, 'success');
        }
    }
    
    generateContactId(chineseName, index) {
        // ä¸­æ–‡ååˆ°æ‹¼éŸ³/è‹±æ–‡IDçš„æ˜ å°„
        const pinyinMap = {
            'æœˆå’æ·±é›ª': 'yukino',
            'è¥¿å›­å¯ºçˆ±ä¸½è': 'arisa',
            'çŠ¬å†¢å¤ç¾': 'natsumi',
            'é˜¿å®…å›': 'otaku',
            'ä¼Šè‰é›…': 'ilya',
            'ç¾æ¸¸': 'miyu',
            'å…‹æ´›ä¼Š': 'kuro',
            'å«å®«å£«éƒ': 'shirou',
            'è¿œå‚å‡›': 'rin',
            'é—´æ¡æ¨±': 'sakura',
            'ç¥ä¹å…‰': 'hikari',
            'çˆ±åŸåæ‹': 'karen',
            'éœ²å´çœŸæ˜¼': 'mahi',
            'çŸ³åŠ¨åŒå¶': 'futaba'
        };
        
        // å¦‚æœåœ¨æ˜ å°„è¡¨ä¸­ï¼Œä½¿ç”¨æ˜ å°„çš„ID
        if (pinyinMap[chineseName]) {
            return pinyinMap[chineseName];
        }
        
        // å¦åˆ™ç”Ÿæˆç®€å•IDï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œç”¨ä¸‹åˆ’çº¿è¿æ¥ï¼‰
        return 'contact_' + chineseName
            .replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '')
            .toLowerCase();
    }
    
    generateRoleDescription(roleName, roleData) {
        // ä¼˜å…ˆä½¿ç”¨MVUæ•°æ®ä¸­çš„æè¿°
        const customDesc = roleData.æè¿° || roleData.å¤‡æ³¨ || roleData.desc || roleData.ç®€ä»‹;
        
        if (customDesc && customDesc.trim() !== '') {
            return customDesc;
        }
        
        // é»˜è®¤æè¿°æ˜ å°„
        const defaultDescs = {
            'æœˆå’æ·±é›ª': 'ç­çº§å§”å‘˜é•¿ï¼Œé»‘å‘æ¸…æ¥šç³»ç¾å°‘å¥³',
            'è¥¿å›­å¯ºçˆ±ä¸½è': 'è¥¿å›­å¯ºè´¢å›¢åƒé‡‘ï¼Œé‡‘å‘å·¨ä¹³å¤§å°å§',
            'çŠ¬å†¢å¤ç¾': 'ç”°å¾„éƒ¨ç‹ç‰Œï¼ŒçŸ­å‘å…ƒæ°”å‡å°å­',
            'é˜¿å®…å›': 'çˆ±ä¸½èçš„é’æ¢…ç«¹é©¬ï¼ŒäºŒæ¬¡å…ƒçˆ±å¥½è€…',
            'ä¼Šè‰é›…': 'ç©—ç¾¤åŸå­¦å›­å°å­¦ç”Ÿï¼Œé­”æ³•å°‘å¥³',
            'ç¾æ¸¸': 'ä¼Šè‰é›…çš„æœ‹å‹ï¼ŒåŒæ ·æ‹¥æœ‰é­”æ³•åŠ›é‡',
            'å…‹æ´›ä¼Š': 'ä¼Šè‰é›…çš„å¦ä¸€ä¸ªåˆ†èº«ï¼Œæ´»æ³¼è°ƒçš®',
            'å«å®«å£«éƒ': 'ä¼Šè‰é›…çš„å“¥å“¥ï¼Œæ“…é•¿æ–™ç†å’Œå®¶åŠ¡',
            'è¿œå‚å‡›': 'é­”æœ¯å¸ˆå®¶æ—çš„å¤§å°å§ï¼Œä¼˜ç­‰ç”Ÿ',
            'é—´æ¡æ¨±': 'æ¸©æŸ”ä½“è´´çš„å­¦å¦¹ï¼Œæ“…é•¿å®¶åŠ¡'
        };
        
        return defaultDescs[roleName] || `${roleName} - è§’è‰²`;
    }
    
    getAvatarInitial(roleName) {
        // å–åå­—çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼ˆä¸­æ–‡åå–ç¬¬ä¸€ä¸ªå­—ï¼‰
        return roleName.charAt(0);
    }
    
    generatePhoneNumber(index) {
        // ç”Ÿæˆå›ºå®šçš„ä¼ªç”µè¯å·ç 
        const baseNumber = '080-1234-';
        const suffix = (1000 + index).toString().padStart(4, '0');
        return baseNumber + suffix;
    }
    
    generateStatus(roleData) {
        // æ ¹æ®è§’è‰²æ•°æ®ç”ŸæˆçŠ¶æ€
        if (roleData.çŠ¶æ€ === 'åœ¨çº¿' || roleData.status === 'online') {
            return 'online';
        } else if (roleData.çŠ¶æ€ === 'å¿™ç¢Œ' || roleData.status === 'busy') {
            return 'busy';
        } else if (roleData.çŠ¶æ€ === 'ç¦»çº¿' || roleData.status === 'offline') {
            return 'offline';
        }
        
        // é»˜è®¤æ ¹æ®å¥½æ„Ÿåº¦åˆ¤æ–­
        const favorability = roleData.å¥½æ„Ÿåº¦ || 0;
        if (favorability > 50) {
            return 'online';
        } else if (favorability < 0) {
            return 'busy';
        } else {
            return 'offline';
        }
    }
    
    generateLastContactTime() {
        // éšæœºç”Ÿæˆæœ€åè”ç³»æ—¶é—´
        const hoursAgo = Math.floor(Math.random() * 72); // 0-72å°æ—¶å‰
        if (hoursAgo < 1) {
            return 'åˆšåˆš';
        } else if (hoursAgo < 24) {
            return `${hoursAgo}å°æ—¶å‰`;
        } else {
            return `${Math.floor(hoursAgo / 24)}å¤©å‰`;
        }
    }
    
    addSystemContacts() {
        const systemContacts = [
            {
                id: 'system_info',
                name: 'ç³»ç»Ÿä¿¡æ¯',
                desc: 'æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œå¸®åŠ©',
                avatar: 'âš™ï¸',
                phone: '080-0000-0000',
                status: 'online',
                lastContact: 'åˆšåˆš',
                mvuData: { ç±»å‹: 'ç³»ç»Ÿ', å¥½æ„Ÿåº¦: 100, è­¦æˆ’åº¦: 0 }
            },
            {
                id: 'emergency',
                name: 'ç´§æ€¥è”ç³»äºº',
                desc: 'è­¦å¯Ÿ/æ•‘æŠ¤è½¦/æ¶ˆé˜²',
                avatar: 'ğŸš¨',
                phone: '110/119',
                status: 'online',
                lastContact: 'ä»æœª',
                mvuData: { ç±»å‹: 'ç´§æ€¥', å¥½æ„Ÿåº¦: 100, è­¦æˆ’åº¦: 0 }
            },
            {
                id: 'weather',
                name: 'å¤©æ°”æœåŠ¡',
                desc: 'å¤©æ°”é¢„æŠ¥å’Œè­¦æŠ¥',
                avatar: 'ğŸŒ¤ï¸',
                phone: '177',
                status: 'online',
                lastContact: '1å°æ—¶å‰',
                mvuData: { ç±»å‹: 'æœåŠ¡', å¥½æ„Ÿåº¦: 100, è­¦æˆ’åº¦: 0 }
            }
        ];
        
        this.contacts.push(...systemContacts);
    }
    
    addSpecialContacts() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ ä»»ä½•ç‰¹æ®Šé€»è¾‘
        // ä¾‹å¦‚ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šçš„ä¸–ç•Œä¹¦æ¡ç›®ï¼Œç„¶åæ·»åŠ å¯¹åº”çš„è”ç³»äºº
    }
    
    setupMvuListener() {
        console.log('è®¾ç½®MVUç›‘å¬å™¨...');
        
        // ç›‘å¬MVUå˜é‡æ›´æ–°äº‹ä»¶
        if (typeof window.eventOn !== 'undefined') {
            try {
                // ç›‘å¬MVUå˜é‡æ›´æ–°ç»“æŸäº‹ä»¶
                window.eventOn('mag_variable_update_ended', (newVariables) => {
                    console.log('æ£€æµ‹åˆ°MVUå˜é‡æ›´æ–°');
                    this.mvuData = newVariables;
                    this.generateContactsFromMvu();
                });
                
                // ç›‘å¬é…’é¦†èŠå¤©å˜åŒ–äº‹ä»¶
                window.eventOn('chat_id_changed', () => {
                    console.log('èŠå¤©æ–‡ä»¶å˜æ›´ï¼Œé‡æ–°åŠ è½½æ•°æ®');
                    setTimeout(() => {
                        this.loadMvuData();
                    }, 1000);
                });
                
                console.log('MVUäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            } catch (error) {
                console.warn('è®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
            }
        } else {
            console.warn('eventOnå‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•è®¾ç½®MVUç›‘å¬å™¨');
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šè½®è¯¢æ£€æŸ¥å˜é‡å˜åŒ–
            this.setupPollingListener();
        }
    }
    
    setupPollingListener() {
        console.log('è®¾ç½®è½®è¯¢ç›‘å¬å™¨...');
        let lastRoleCount = 0;
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è§’è‰²æ•°é‡å˜åŒ–
        setInterval(() => {
            if (this.mvuData?.stat_data?.è§’è‰²) {
                const currentRoleCount = Object.keys(this.mvuData.stat_data.è§’è‰²).length;
                if (currentRoleCount !== lastRoleCount) {
                    console.log(`è§’è‰²æ•°é‡å˜åŒ–: ${lastRoleCount} -> ${currentRoleCount}`);
                    lastRoleCount = currentRoleCount;
                    this.generateContactsFromMvu();
                }
            }
        }, 30000); // 30ç§’
    }
    
    async syncContactsFromMvu() {
        try {
            this.showNotification('æ­£åœ¨åŒæ­¥è”ç³»äºº...', 'info');
            await this.loadMvuData();
            this.showNotification(`åŒæ­¥å®Œæˆï¼Œå…±${this.contacts.length}ä¸ªè”ç³»äºº`, 'success');
        } catch (error) {
            console.error('åŒæ­¥å¤±è´¥:', error);
            this.showNotification('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', 'error');
        }
    }
    
    promptAddContact() {
        // ç®€åŒ–ç‰ˆæ·»åŠ è”ç³»äººå¼¹çª—
        const name = prompt('è¾“å…¥è”ç³»äººå§“å:');
        if (!name) return;
        
        const desc = prompt('è¾“å…¥è”ç³»äººæè¿°:') || 'æ–°çš„è”ç³»äºº';
        
        const newContact = {
            id: 'custom_' + Date.now(),
            name: name,
            desc: desc,
            avatar: name.charAt(0),
            phone: '080-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0') + '-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0'),
            status: 'offline',
            lastContact: 'ä»æœª',
            mvuData: { å¥½æ„Ÿåº¦: 0, è­¦æˆ’åº¦: 0, æœä»åº¦: 0, æ€§æ¬²: 0, ç±»å‹: 'è‡ªå®šä¹‰' }
        };
        
        this.contacts.push(newContact);
        this.updateContactList();
        this.updateMessageContacts();
        
        this.showNotification(`å·²æ·»åŠ è”ç³»äºº: ${name}`, 'success');
    }
    
    // ===== é€šè®¯å½•æ˜¾ç¤º =====
    updateContactList() {
        const container = document.getElementById('pfContactList');
        const countElement = document.getElementById('pfContactCount');
        
        if (!container) return;
        
        // æ›´æ–°æ•°é‡
        if (countElement) {
            countElement.textContent = this.contacts.length;
        }
        
        // å¦‚æœæ²¡æœ‰è”ç³»äºº
        if (this.contacts.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: #999; padding: 60px 0;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‡</div>
                    <div style="margin-bottom: 12px;">æ²¡æœ‰æ‰¾åˆ°è”ç³»äºº</div>
                    <div style="font-size: 12px; margin-bottom: 20px;">è¯·ç¡®ä¿MVUå˜é‡ç³»ç»Ÿå·²åˆå§‹åŒ–</div>
                    <button id="pfRetryLoad" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        é‡è¯•åŠ è½½
                    </button>
                </div>
            `;
            
            // ç»‘å®šé‡è¯•æŒ‰é’®
            const retryBtn = document.getElementById('pfRetryLoad');
            if (retryBtn) {
                retryBtn.addEventListener('click', async () => {
                    await this.loadMvuData();
                });
            }
            
            return;
        }
        
        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';
        
        // æŒ‰é¦–å­—æ¯æ’åº
        const sortedContacts = [...this.contacts].sort((a, b) => {
            return a.name.localeCompare(b.name, 'zh-CN');
        });
        
        // æŒ‰é¦–å­—æ¯åˆ†ç»„
        const groupedContacts = {};
        sortedContacts.forEach(contact => {
            const firstChar = contact.name.charAt(0).toUpperCase();
            if (!groupedContacts[firstChar]) {
                groupedContacts[firstChar] = [];
            }
            groupedContacts[firstChar].push(contact);
        });
        
        // æ¸²æŸ“åˆ†ç»„
        Object.keys(groupedContacts).sort().forEach(letter => {
            // å­—æ¯æ ‡é¢˜
            const letterHeader = document.createElement('div');
            letterHeader.style.cssText = `
                padding: 8px 0;
                margin-top: 16px;
                font-weight: bold;
                color: #667eea;
                border-bottom: 1px solid rgba(0,0,0,0.1);
                font-size: 14px;
            `;
            letterHeader.textContent = letter;
            container.appendChild(letterHeader);
            
            // è¯¥å­—æ¯ä¸‹çš„è”ç³»äºº
            groupedContacts[letter].forEach(contact => {
                const contactElement = this.createContactElement(contact);
                container.appendChild(contactElement);
            });
        });
    }
    
    createContactElement(contact) {
        const element = document.createElement('div');
        element.className = 'pf-contact-item';
        element.dataset.id = contact.id;
        
        // çŠ¶æ€æŒ‡ç¤ºå™¨
        const statusClass = {
            'online': 'pf-status-online',
            'offline': 'pf-status-offline',
            'busy': 'pf-status-busy'
        }[contact.status] || 'pf-status-offline';
        
        // ç»Ÿè®¡æ•°æ®
        const statsHtml = contact.mvuData ? `
            <div class="pf-contact-stats">
                <span class="pf-stat-item" title="å¥½æ„Ÿåº¦">â™¥${contact.mvuData.å¥½æ„Ÿåº¦ || 0}</span>
                <span class="pf-stat-item" title="è­¦æˆ’åº¦">âš ${contact.mvuData.è­¦æˆ’åº¦ || 0}</span>
                <span class="pf-stat-item" title="æœä»åº¦">ğŸ“‹${contact.mvuData.æœä»åº¦ || 0}</span>
                <span class="pf-stat-item" title="æ€§æ¬²">ğŸ”¥${contact.mvuData.æ€§æ¬² || 0}</span>
            </div>
        ` : '';
        
        element.innerHTML = `
            <div class="pf-contact-avatar">${contact.avatar}</div>
            <div class="pf-contact-info">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <span class="pf-contact-name">${contact.name}</span>
                    <span class="pf-status-indicator ${statusClass}" title="${contact.status === 'online' ? 'åœ¨çº¿' : contact.status === 'busy' ? 'å¿™ç¢Œ' : 'ç¦»çº¿'}"></span>
                </div>
                <div class="pf-contact-desc">${contact.desc}</div>
                <div style="font-size: 11px; color: #888; margin-top: 2px;">
                    <span title="ç”µè¯å·ç ">ğŸ“ ${contact.phone}</span>
                    <span style="margin-left: 12px;" title="æœ€åè”ç³»">ğŸ• ${contact.lastContact}</span>
                </div>
                ${statsHtml}
            </div>
            <div class="pf-contact-actions">
                <button class="pf-action-btn pf-call-btn" title="æ‰“ç”µè¯">
                    ğŸ“
                </button>
                <button class="pf-action-btn pf-message-btn" title="å‘çŸ­ä¿¡">
                    ğŸ’¬
                </button>
            </div>
        `;
        
        // ç»‘å®šäº‹ä»¶
        element.addEventListener('click', (e) => {
            if (!e.target.closest('.pf-contact-actions')) {
                this.showContactDetail(contact);
            }
        });
        
        element.querySelector('.pf-call-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.makeCall(contact);
        });
        
        element.querySelector('.pf-message-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.openMessageTo(contact);
        });
        
        return element;
    }
    
    showContactDetail(contact) {
        // æ˜¾ç¤ºè”ç³»äººè¯¦æƒ…
        const detailHtml = `
            <div style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold; margin-bottom: 16px;">
                        ${contact.avatar}
                    </div>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">${contact.name}</div>
                    <div style="color: #666; margin-bottom: 16px;">${contact.desc}</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.03); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">ç”µè¯</span>
                        <span style="font-weight: 500;">${contact.phone}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">çŠ¶æ€</span>
                        <span style="font-weight: 500; color: ${contact.status === 'online' ? '#4caf50' : contact.status === 'busy' ? '#f44336' : '#9e9e9e'}">
                            ${contact.status === 'online' ? 'åœ¨çº¿' : contact.status === 'busy' ? 'å¿™ç¢Œ' : 'ç¦»çº¿'}
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">æœ€åè”ç³»</span>
                        <span style="font-weight: 500;">${contact.lastContact}</span>
                    </div>
                </div>
                
                ${contact.mvuData ? `
                <div style="background: rgba(0,0,0,0.03); border-radius: 12px; padding: 16px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: #667eea;">è§’è‰²æ•°æ®</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">å¥½æ„Ÿåº¦</div>
                            <div style="font-size: 20px; font-weight: bold; color: #e91e63;">â™¥${contact.mvuData.å¥½æ„Ÿåº¦ || 0}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">è­¦æˆ’åº¦</div>
                            <div style="font-size: 20px; font-weight: bold; color: #ff9800;">âš ${contact.mvuData.è­¦æˆ’åº¦ || 0}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">æœä»åº¦</div>
                            <div style="font-size: 20px; font-weight: bold; color: #2196f3;">ğŸ“‹${contact.mvuData.æœä»åº¦ || 0}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">æ€§æ¬²</div>
                            <div style="font-size: 20px; font-weight: bold; color: #f44336;">ğŸ”¥${contact.mvuData.æ€§æ¬² || 0}</div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button id="pfDetailCall" style="flex: 1; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        ğŸ“ æ‰“ç”µè¯
                    </button>
                    <button id="pfDetailMessage" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        ğŸ’¬ å‘çŸ­ä¿¡
                    </button>
                </div>
            </div>
        `;
        
        // åˆ›å»ºå¼¹çª—
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: pf-slideIn 0.3s ease-out;
        `;
        
        modal.innerHTML = `
            <div style="background: white; width: 90%; max-width: 400px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <div style="position: relative;">
                    ${detailHtml}
                    <button id="pfCloseDetail" style="position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; cursor: pointer; font-size: 20px;">Ã—</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ç»‘å®šäº‹ä»¶
        document.getElementById('pfCloseDetail').addEventListener('click', () => {
            modal.remove();
        });
        
        document.getElementById('pfDetailCall').addEventListener('click', () => {
            this.makeCall(contact);
            modal.remove();
        });
        
        document.getElementById('pfDetailMessage').addEventListener('click', () => {
            this.openMessageTo(contact);
            modal.remove();
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }
    
    updateMessageContacts() {
        const select = document.getElementById('pfMessageTo');
        if (!select) return;
        
        // ä¿å­˜å½“å‰é€‰æ‹©
        const currentValue = select.value;
        
        // æ¸…ç©ºé€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªï¼‰
        select.innerHTML = '<option value="">é€‰æ‹©è”ç³»äºº...</option>';
        
        // æŒ‰å­—æ¯æ’åºè”ç³»äºº
        const sortedContacts = [...this.contacts].sort((a, b) => {
            return a.name.localeCompare(b.name, 'zh-CN');
        });
        
        // æ·»åŠ è”ç³»äººé€‰é¡¹
        sortedContacts.forEach(contact => {
            const option = document.createElement('option');
            option.value = contact.id;
            option.textContent = `${contact.name} (${contact.desc.substring(0, 20)}...)`;
            select.appendChild(option);
        });
        
        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
        if (currentValue && this.contacts.some(c => c.id === currentValue)) {
            select.value = currentValue;
        }
    }
    
    // ===== çŸ­ä¿¡åŠŸèƒ½ =====
    makeCall(contact) {
        if (!contact) return;
        
        // å‘é€æ‰“ç”µè¯çš„æ¶ˆæ¯åˆ°AI
        const message = `ã€æ‰“ç”µè¯ã€‘ç»™${contact.name}æ‰“ç”µè¯ï¼Œç”µè¯å·ç æ˜¯${contact.phone}`;
        this.sendMessageToAI(message);
        
        // æ˜¾ç¤ºå‘¼å«ç•Œé¢
        this.showCallInterface(contact);
        
        // åˆ‡æ¢åˆ°çŸ­ä¿¡ç•Œé¢
        this.switchTab('messages');
        
        // è‡ªåŠ¨åˆ‡æ¢åˆ°è¯¥è”ç³»äºº
        document.getElementById('pfMessageTo').value = contact.id;
        this.currentChatContact = contact;
        this.loadChatHistory(contact.id);
    }
    
    showCallInterface(contact) {
        // æ·»åŠ åˆ°æ¶ˆæ¯å†å²
        this.addMessageToHistory(contact.id, {
            type: 'system',
            text: `æ­£åœ¨å‘¼å« ${contact.name}...`,
            time: new Date().toLocaleTimeString()
        });
    }
    
    openMessageTo(contact) {
        this.switchTab('messages');
        document.getElementById('pfMessageTo').value = contact.id;
        this.currentChatContact = contact;
        this.loadChatHistory(contact.id);
        document.getElementById('pfMessageInput').focus();
    }
    
    sendMessage() {
        const contactId = document.getElementById('pfMessageTo').value;
        const messageText = document.getElementById('pfMessageInput').value.trim();
        
        if (!contactId) {
            this.showNotification('è¯·å…ˆé€‰æ‹©è”ç³»äºº', 'warning');
            return;
        }
        
        if (!messageText) {
            this.showNotification('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
            return;
        }
        
        const contact = this.contacts.find(c => c.id === contactId);
        if (!contact) {
            this.showNotification('è”ç³»äººä¸å­˜åœ¨', 'error');
            return;
        }
        
        // æ·»åŠ åˆ°æ¶ˆæ¯å†å²
        this.addMessageToHistory(contactId, {
            type: 'sent',
            text: messageText,
            contact: contact.name,
            time: new Date().toLocaleTimeString()
        });
        
        // å‘é€åˆ°AI
        const aiMessage = `ã€å‘çŸ­ä¿¡ã€‘ç»™${contact.name}å‘é€çŸ­ä¿¡ï¼š${messageText}`;
        this.sendMessageToAI(aiMessage);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('pfMessageInput').value = '';
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        const history = document.getElementById('pfMessageHistory');
        history.scrollTop = history.scrollHeight;
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        this.saveMessageHistory();
    }
    
    addMessageToHistory(contactId, message) {
        const history = document.getElementById('pfMessageHistory');
        
        // åˆå§‹åŒ–æ¶ˆæ¯å†å²
        if (!this.messages[contactId]) {
            this.messages[contactId] = [];
        }
        
        // æ·»åŠ åˆ°å†…å­˜
        this.messages[contactId].push({
            ...message,
            timestamp: Date.now()
        });
        
        // é™åˆ¶å†å²è®°å½•é•¿åº¦
        if (this.messages[contactId].length > 100) {
            this.messages[contactId] = this.messages[contactId].slice(-100);
        }
        
        // æ¸²æŸ“æ¶ˆæ¯
        this.renderChatHistory(contactId);
    }
    
    loadChatHistory(contactId) {
        if (!this.messages[contactId]) {
            this.messages[contactId] = [];
        }
        this.renderChatHistory(contactId);
    }
    
    renderChatHistory(contactId) {
        const history = document.getElementById('pfMessageHistory');
        const messages = this.messages[contactId] || [];
        
        // æ¸…ç©ºå†å²
        history.innerHTML = '';
        
        if (messages.length === 0) {
            history.innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px 0;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¬</div>
                    <div>è¿˜æ²¡æœ‰å’Œ${this.currentChatContact?.name || 'å¯¹æ–¹'}çš„èŠå¤©è®°å½•</div>
                    <div style="font-size: 12px; margin-top: 8px;">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>
                </div>
            `;
            return;
        }
        
        // æ¸²æŸ“æ¯æ¡æ¶ˆæ¯
        messages.forEach(msg => {
            const messageElement = document.createElement('div');
            
            let bubbleClass = 'pf-message-bubble ';
            if (msg.type === 'sent') {
                bubbleClass += 'pf-message-sent';
            } else if (msg.type === 'system') {
                bubbleClass += 'pf-message-system';
            } else {
                bubbleClass += 'pf-message-received';
            }
            
            messageElement.className = bubbleClass;
            messageElement.innerHTML = `
                <div class="pf-message-time">${msg.time}</div>
                <div>${msg.text}</div>
            `;
            
            history.appendChild(messageElement);
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => {
            history.scrollTop = history.scrollHeight;
        }, 100);
    }
    
    clearChatHistory() {
        const history = document.getElementById('pfMessageHistory');
        history.innerHTML = `
            <div style="text-align: center; color: #999; padding: 40px 0;">
                é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©
            </div>
        `;
    }
    
    loadMessageHistory() {
        try {
            const saved = localStorage.getItem('pf-messages-v2');
            if (saved) {
                this.messages = JSON.parse(saved);
                console.log('åŠ è½½æ¶ˆæ¯å†å²:', Object.keys(this.messages).length, 'ä¸ªè”ç³»äººçš„è®°å½•');
            }
        } catch (e) {
            console.warn('æ— æ³•åŠ è½½æ¶ˆæ¯å†å²:', e);
            this.messages = {};
        }
    }
    
    saveMessageHistory() {
        try {
            localStorage.setItem('pf-messages-v2', JSON.stringify(this.messages));
        } catch (e) {
            console.warn('æ— æ³•ä¿å­˜æ¶ˆæ¯å†å²:', e);
        }
    }
    
    // ===== AIé€šä¿¡ =====
    sendMessageToAI(message) {
        console.log('å‘é€æ¶ˆæ¯åˆ°AI:', message);
        
        try {
            // æ–¹æ³•1: ä½¿ç”¨é…’é¦†åŠ©æ‰‹çš„triggerSlash
            if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.triggerSlash) {
                window.TavernHelper.triggerSlash(`/say ${message}`);
                return;
            }
            
            // æ–¹æ³•2: ä½¿ç”¨é…’é¦†åŠ©æ‰‹çš„createChatMessages
            if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.createChatMessages) {
                window.TavernHelper.createChatMessages([{
                    role: 'user',
                    message: message
                }]);
                return;
            }
            
            // æ–¹æ³•3: å‘é€è‡ªå®šä¹‰äº‹ä»¶
            const event = new CustomEvent('send-user-message', {
                detail: { text: message }
            });
            window.dispatchEvent(event);
            
            // æ–¹æ³•4: é€šè¿‡postMessageåˆ°çˆ¶çª—å£
            if (window.parent) {
                window.parent.postMessage({
                    type: 'user-message',
                    text: message
                }, '*');
            }
            
            // æ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ä½œä¸ºå¤‡ç”¨
            if (this.currentChatContact) {
                this.addMessageToHistory(this.currentChatContact.id, {
                    type: 'system',
                    text: `[å·²å‘é€åˆ°AI]: ${message}`,
                    time: new Date().toLocaleTimeString()
                });
            }
            
        } catch (error) {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            this.showNotification('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', 'error');
        }
    }
    
    // ===== å·¥å…·å‡½æ•° =====
    showNotification(message, type = 'info') {
        const colors = {
            'info': '#667eea',
            'success': '#4caf50',
            'warning': '#ff9800',
            'error': '#f44336'
        };
        
        const icon = {
            'info': 'â„¹ï¸',
            'success': 'âœ…',
            'warning': 'âš ï¸',
            'error': 'âŒ'
        }[type] || 'â„¹ï¸';
        
        // ç§»é™¤å·²æœ‰çš„é€šçŸ¥
        const existing = document.querySelectorAll('.pf-notification');
        existing.forEach(el => el.remove());
        
        // åˆ›å»ºæ–°é€šçŸ¥
        const notification = document.createElement('div');
        notification.className = 'pf-notification';
        notification.style.background = colors[type] || colors.info;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="font-size: 16px;">${icon}</div>
                <div>
                    <div style="font-weight: 600; font-size: 14px;">æ‰‹æœºåŠŸèƒ½</div>
                    <div style="font-size: 12px; opacity: 0.9;">${message}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.style.animation = 'pf-notificationOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    loadFallbackContacts() {
        console.log('ä½¿ç”¨å¤‡ç”¨é€šè®¯å½•æ•°æ®');
        this.contacts = [
            {
                id: 'yukino',
                name: 'æœˆå’æ·±é›ª',
                desc: 'ç­çº§å§”å‘˜é•¿ï¼Œé»‘å‘æ¸…æ¥šç³»ç¾å°‘å¥³',
                avatar: 'é›ª',
                phone: '080-1111-2222',
                status: 'online',
                lastContact: '2å°æ—¶å‰',
                mvuData: { å¥½æ„Ÿåº¦: 50, è­¦æˆ’åº¦: 10, æœä»åº¦: 30, æ€§æ¬²: 5, æè¿°: 'ç­çº§å§”å‘˜é•¿ï¼Œé»‘å‘æ¸…æ¥šç³»ç¾å°‘å¥³' }
            },
            {
                id: 'arisa',
                name: 'è¥¿å›­å¯ºçˆ±ä¸½è',
                desc: 'è¥¿å›­å¯ºè´¢å›¢åƒé‡‘ï¼Œé‡‘å‘å·¨ä¹³å¤§å°å§',
                avatar: 'çˆ±',
                phone: '080-2222-3333',
                status: 'online',
                lastContact: '1å¤©å‰',
                mvuData: { å¥½æ„Ÿåº¦: 70, è­¦æˆ’åº¦: 20, æœä»åº¦: 10, æ€§æ¬²: 15, æè¿°: 'è¥¿å›­å¯ºè´¢å›¢åƒé‡‘ï¼Œé‡‘å‘å·¨ä¹³å¤§å°å§' }
            },
            {
                id: 'natsumi',
                name: 'çŠ¬å†¢å¤ç¾',
                desc: 'ç”°å¾„éƒ¨ç‹ç‰Œï¼ŒçŸ­å‘å…ƒæ°”å‡å°å­',
                avatar: 'å¤',
                phone: '080-3333-4444',
                status: 'offline',
                lastContact: 'åˆšåˆš',
                mvuData: { å¥½æ„Ÿåº¦: 80, è­¦æˆ’åº¦: 5, æœä»åº¦: 40, æ€§æ¬²: 10, æè¿°: 'ç”°å¾„éƒ¨ç‹ç‰Œï¼ŒçŸ­å‘å…ƒæ°”å‡å°å­' }
            },
            {
                id: 'otaku',
                name: 'é˜¿å®…å›',
                desc: 'çˆ±ä¸½èçš„é’æ¢…ç«¹é©¬ï¼ŒäºŒæ¬¡å…ƒçˆ±å¥½è€…',
                avatar: 'å®…',
                phone: '080-4444-5555',
                status: 'busy',
                lastContact: '3å¤©å‰',
                mvuData: { å¥½æ„Ÿåº¦: 40, è­¦æˆ’åº¦: 30, æœä»åº¦: 20, æ€§æ¬²: 25, æè¿°: 'çˆ±ä¸½èçš„é’æ¢…ç«¹é©¬ï¼ŒäºŒæ¬¡å…ƒçˆ±å¥½è€…' }
            },
            {
                id: 'ilya',
                name: 'ä¼Šè‰é›…',
                desc: 'ç©—ç¾¤åŸå­¦å›­å°å­¦ç”Ÿï¼Œé­”æ³•å°‘å¥³',
                avatar: 'ä¼Š',
                phone: '080-5555-6666',
                status: 'online',
                lastContact: '5å°æ—¶å‰',
                mvuData: { å¥½æ„Ÿåº¦: 90, è­¦æˆ’åº¦: 0, æœä»åº¦: 60, æ€§æ¬²: 0, æè¿°: 'ç©—ç¾¤åŸå­¦å›­å°å­¦ç”Ÿï¼Œé­”æ³•å°‘å¥³' }
            }
        ];
        
        this.addSystemContacts();
        this.updateContactList();
        this.updateMessageContacts();
    }
}

// ===== å…¨å±€åˆå§‹åŒ– =====
// ç­‰å¾…DOMåŠ è½½å®Œæˆ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePhoneFunctions);
} else {
    initializePhoneFunctions();
}

function initializePhoneFunctions() {
    try {
        // ç¡®ä¿ä¸ä¼šé‡å¤åˆå§‹åŒ–
        if (!window.pfInstance) {
            window.pfInstance = new PhoneFunctions();
            console.log('æ‰‹æœºåŠŸèƒ½å‰ç«¯å·²åˆå§‹åŒ–');
            
            // å…¨å±€å¯¼å‡ºï¼ˆå¦‚æœéœ€è¦ï¼‰
            window.PhoneFunctions = PhoneFunctions;
        }
    } catch (error) {
        console.error('æ‰‹æœºåŠŸèƒ½å‰ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10003;
            max-width: 300px;
            font-size: 12px;
        `;
        errorDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 4px;">æ‰‹æœºåŠŸèƒ½åŠ è½½å¤±è´¥</div>
            <div>${error.message}</div>
        `;
        document.body.appendChild(errorDiv);
        
        // 10ç§’åç§»é™¤é”™è¯¯ä¿¡æ¯
        setTimeout(() => errorDiv.remove(), 10000);
    }
}

// æ·»åŠ åŠ¨ç”»æ ·å¼
if (!document.querySelector('#pf-animation-styles')) {
    const style = document.createElement('style');
    style.id = 'pf-animation-styles';
    style.textContent = `
        @keyframes pf-slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pf-notificationIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes pf-notificationOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}
</script>
</body>
</html>
