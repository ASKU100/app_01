<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>å‚¬çœ APPæ‰©å±• - STé›†æˆç‰ˆ</title>
    <style>
        /* ====== é’ˆå¯¹SillyTavernçš„å“åº”å¼è§„åˆ™ ====== */
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #764ba2;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --info-color: #4299e1;
            
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            
            --border-color: #e2e8f0;
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            
            /* å“åº”å¼å˜é‡ */
            --st-safe-area-top: 50px;
            --st-safe-area-bottom: 70px;
            --st-max-height: calc(100vh - 120px);
            --st-min-height: 500px;
        }

        /* åŸºç¡€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* ä¸»å®¹å™¨ - å…³é”®å“åº”å¼è®¾ç½® */
        #hypnosis-extension {
            width: 100%;
            height: 100%;
            min-height: var(--st-min-height);
            max-height: var(--st-max-height);
            background: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg), 0 20px 80px rgba(102, 126, 234, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border-color);
            animation: panelSlideIn 0.3s ease-out;
            resize: vertical;
            overflow: auto;
        }

        @keyframes panelSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ====== å¤´éƒ¨æ ·å¼ ====== */
        .extension-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 16px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .app-title h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .app-subtitle {
            font-size: 11px;
            opacity: 0.9;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: white;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ====== æ ‡ç­¾é¡µæ ·å¼ ====== */
        .extension-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px 0;
            flex-shrink: 0;
            position: relative;
        }

        .tab-button {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            position: relative;
            transition: all var(--transition-fast);
            border-radius: 8px 8px 0 0;
            min-height: 44px;
        }

        .tab-button:hover {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-button.active {
            color: var(--primary-color);
            background: var(--bg-card);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 8px;
            right: 8px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px 2px 0 0;
        }

        .tab-icon {
            font-size: 16px;
        }

        .tab-label {
            font-size: 11px;
        }

        /* æœªè¯»å¾½ç« æ ·å¼ */
        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ====== æ ‡ç­¾é¡µå†…å®¹å®¹å™¨ ====== */
        .tab-content-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .tab-content.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ====== åœ°å›¾æ ‡ç­¾é¡µ ====== */
        .map-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .tab-header {
            margin-bottom: 8px;
        }

        .tab-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .tab-description {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .map-preview {
            flex: 1;
            min-height: 200px;
            background: linear-gradient(135deg, #e9f4ff 0%, #f0f7ff 100%);
            border-radius: var(--border-radius);
            border: 2px solid #dbeafe;
            position: relative;
            overflow: hidden;
        }

        .map-grid {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .map-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 2;
        }

        .marker-dot {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid white;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-fast);
        }

        .map-marker:hover .marker-dot {
            transform: translate(-50%, -50%) scale(1.3);
            background: var(--danger-color);
        }

        .location-info {
            min-height: 80px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 12px;
        }

        .info-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }

        .placeholder-icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        .map-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        /* ====== æŒ‰é’®æ ·å¼ ====== */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-fast);
            flex: 1;
            font-size: 13px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-fast);
            flex: 1;
            font-size: 13px;
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--primary-color);
        }

        .btn-icon {
            font-size: 14px;
        }

        /* ====== é€šè®¯å½•æ ‡ç­¾é¡µ ====== */
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
            z-index: 2;
        }

        .search-box input {
            width: 100%;
            padding: 12px 14px 12px 38px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            transition: all var(--transition-fast);
            background: var(--bg-card);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 4px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: 8px;
            min-height: 44px;
            border: 1px solid transparent;
            position: relative;
        }

        .contact-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
        }

        .contact-item.has-unread {
            border-left: 3px solid var(--primary-color);
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05), transparent);
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            font-size: 13px;
        }

        .contact-phone {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .contact-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 20px;
            background: var(--bg-secondary);
            width: fit-content;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-online {
            background: var(--success-color);
        }

        .status-busy {
            background: var(--warning-color);
        }

        .status-offline {
            background: var(--text-muted);
        }

        /* è”ç³»äººæœªè¯»å¾½ç«  */
        .contact-unread-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .contacts-stats {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 12px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* ====== çŸ­ä¿¡æ ‡ç­¾é¡µ - æ”¹è¿›ç‰ˆ ====== */
        .sms-recipient {
            margin-bottom: 16px;
        }

        .recipient-select {
            position: relative;
            margin-bottom: 8px;
        }

        .select-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            z-index: 2;
        }

        .recipient-select select {
            width: 100%;
            padding: 12px 14px 12px 38px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            background: var(--bg-card);
            appearance: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .recipient-select select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .select-arrow {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            font-size: 12px;
        }

        /* çŸ­ä¿¡å¯¹è¯å®¹å™¨ - æ”¹è¿›å¸ƒå±€ */
        .sms-conversation-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--bg-primary);
            margin-bottom: 16px;
        }

        .sms-conversation-header {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sms-conversation {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            min-height: 150px;
            max-height: 300px;
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.received .message-avatar {
            background: linear-gradient(135deg, #edf2f7, #e2e8f0);
        }

        .message.sent .message-avatar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .message-content {
            max-width: 75%;
            background: white;
            border-radius: 12px;
            padding: 10px 14px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            margin-left: auto;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
        }

        .message.sent .message-header {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-text {
            font-size: 12px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .sms-input-area {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
            background: var(--bg-card);
        }

        .sms-input-area textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            resize: vertical;
            transition: all var(--transition-fast);
            background: var(--bg-card);
            min-height: 80px;
            max-height: 150px;
        }

        .sms-input-area textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .char-counter {
            font-size: 11px;
            color: var(--text-muted);
        }

        .char-counter.warning {
            color: var(--warning-color);
        }

        .char-counter.error {
            color: var(--danger-color);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-fast);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            font-size: 13px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ====== è°ƒæ•´å¤§å°æ‰‹æŸ„ ====== */
        .resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 12px;
            cursor: ns-resize;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resize-handle:hover {
            opacity: 1;
        }

        .resize-handle::before {
            content: '';
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
        }

        /* ====== åŠ è½½çŠ¶æ€ ====== */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* ====== æ»šåŠ¨æ¡æ ·å¼ ====== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ====== å“åº”å¼åª’ä½“æŸ¥è¯¢ ====== */
        @media (max-height: 700px) {
            :root {
                --st-max-height: calc(100vh - 100px);
                --st-min-height: 450px;
            }
            
            .tab-content {
                padding: 16px;
            }
            
            .map-preview {
                min-height: 180px;
            }
            
            .sms-conversation {
                min-height: 180px;
            }
        }

        @media (max-height: 550px) {
            :root {
                --st-max-height: calc(100vh - 80px);
                --st-min-height: 380px;
            }
            
            .extension-header {
                padding: 12px 16px;
            }
            
            .extension-tabs {
                padding: 6px 12px 0;
            }
            
            .tab-button {
                padding: 8px 6px;
                font-size: 11px;
            }
            
            .tab-content {
                padding: 12px;
            }
            
            .map-preview {
                min-height: 150px;
            }
            
            .sms-conversation {
                min-height: 150px;
                padding: 12px;
            }
            
            .message {
                margin-bottom: 12px;
            }
        }

        @media (max-height: 450px) {
            :root {
                --st-min-height: 300px;
            }
            
            .extension-header {
                padding: 8px 12px;
            }
            
            .app-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            .extension-tabs {
                padding: 4px 8px 0;
            }
            
            .tab-button {
                padding: 6px 4px;
                font-size: 10px;
                min-height: 36px;
            }
            
            .tab-icon {
                font-size: 14px;
            }
            
            .map-preview {
                min-height: 120px;
            }
            
            .sms-conversation {
                min-height: 120px;
                padding: 8px;
            }
            
            .sms-input-area textarea {
                min-height: 60px;
                padding: 8px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .tab-button,
            .contact-item,
            button,
            .send-btn {
                min-height: 44px;
            }
            
            .search-box input,
            .recipient-select select,
            .sms-input-area textarea {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="hypnosis-extension">
        <!-- å¤´éƒ¨ -->
        <div class="extension-header">
            <div class="header-left">
                <div class="app-icon">âœ¨</div>
                <div class="app-title">
                    <h3>å‚¬çœ APPæ‰©å±•</h3>
                    <p class="app-subtitle">åŠ¨æ€è§’è‰²åŠ è½½ç‰ˆ v1.1.0</p>
                </div>
            </div>
            <div class="header-right">
                <button class="close-btn" onclick="closeExtension()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="extension-tabs">
            <button class="tab-button active" onclick="switchTab('map')">
                <span class="tab-icon">ğŸ—ºï¸</span>
                <span class="tab-label">åœ°å›¾</span>
            </button>
            <button class="tab-button" onclick="switchTab('contacts')" id="contacts-tab-btn">
                <span class="tab-icon">ğŸ“</span>
                <span class="tab-label">é€šè®¯å½•</span>
            </button>
            <button class="tab-button" onclick="switchTab('sms')" id="sms-tab-btn">
                <span class="tab-icon">ğŸ’¬</span>
                <span class="tab-label">çŸ­ä¿¡</span>
            </button>
        </div>

        <!-- å†…å®¹å®¹å™¨ -->
        <div class="tab-content-container">
            <!-- åœ°å›¾æ ‡ç­¾é¡µ -->
            <div id="map-tab" class="tab-content active">
                <div class="map-container">
                    <div class="tab-header">
                        <h4 class="tab-title">ç§ç«‹æ–‹æ˜å­¦å›­åœ°å›¾</h4>
                        <p class="tab-description">æ¢ç´¢æ ¡å›­å„ä¸ªåœ°ç‚¹ï¼Œå¿«é€Ÿç§»åŠ¨</p>
                    </div>
                    
                    <div class="map-preview">
                        <div class="map-grid">
                            <!-- åœ°å›¾æ ‡è®° -->
                            <div class="map-marker" style="top: 30%; left: 40%;" 
                                 onclick="showLocationInfo('æ•™å­¦æ¥¼', 'äºŒå¹´çº§æ•™å®¤ã€å›¾ä¹¦å®¤ã€ç”µè„‘å®¤')">
                                <div class="marker-dot"></div>
                            </div>
                            <div class="map-marker" style="top: 60%; left: 20%;" 
                                 onclick="showLocationInfo('ä½“è‚²é¦†', 'è¿åŠ¨åœºåœ°ï¼Œæ›´è¡£å®¤å’Œæ·‹æµ´é—´')">
                                <div class="marker-dot"></div>
                            </div>
                            <div class="map-marker" style="top: 40%; left: 70%;" 
                                 onclick="showLocationInfo('æ—§æ ¡èˆ', 'åˆä¼‘é¿éš¾æ‰€ï¼Œå®‰é™å°‘äºº')">
                                <div class="marker-dot"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="location-info" id="location-info">
                        <div class="info-placeholder">
                            <div class="placeholder-icon">ğŸ“</div>
                            <p>ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°æŸ¥çœ‹åœ°ç‚¹è¯¦æƒ…</p>
                        </div>
                    </div>
                    
                    <div class="map-actions">
                        <button class="btn-primary" onclick="refreshMap()">
                            <span class="btn-icon">ğŸ”„</span>
                            åˆ·æ–°åœ°å›¾
                        </button>
                        <button class="btn-secondary" onclick="showAllLocations()">
                            <span class="btn-icon">ğŸ“‹</span>
                            æ‰€æœ‰åœ°ç‚¹
                        </button>
                    </div>
                </div>
            </div>

            <!-- é€šè®¯å½•æ ‡ç­¾é¡µ -->
            <div id="contacts-tab" class="tab-content">
                <div class="tab-header">
                    <h4 class="tab-title">é€šè®¯å½•</h4>
                    <p class="tab-description">ä»[initvar]å˜é‡åŠ¨æ€åŠ è½½è§’è‰²</p>
                </div>
                
                <div class="search-box">
                    <div class="search-icon">ğŸ”</div>
                    <input type="text" id="contact-search" placeholder="æœç´¢è”ç³»äºº..." oninput="filterContacts()">
                </div>
                
                <div class="contacts-list" id="contacts-list">
                    <div class="loading-container" id="contacts-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">æ­£åœ¨ä»[initvar]å˜é‡åŠ è½½è§’è‰²...</div>
                    </div>
                </div>
                
                <div class="contacts-stats">
                    <span class="stat-item">
                        <span class="stat-label">è”ç³»äºº</span>
                        <span class="stat-value" id="contact-count">0</span>
                    </span>
                    <span class="stat-item">
                        <span class="stat-label">åœ¨çº¿</span>
                        <span class="stat-value" id="online-count">0</span>
                    </span>
                    <span class="stat-item">
                        <span class="stat-label">æœªè¯»</span>
                        <span class="stat-value" id="unread-count">0</span>
                    </span>
                </div>
            </div>

            <!-- çŸ­ä¿¡æ ‡ç­¾é¡µ -->
            <div id="sms-tab" class="tab-content">
                <div class="tab-header">
                    <h4 class="tab-title">çŸ­ä¿¡</h4>
                    <p class="tab-description">ä¸SillyTavernèŠå¤©é›†æˆ</p>
                </div>
                
                <div class="sms-recipient">
                    <div class="recipient-select">
                        <div class="select-icon">ğŸ‘¤</div>
                        <select id="sms-contact">
                            <option value="">é€‰æ‹©è”ç³»äºº</option>
                            <option value="" disabled>æ­£åœ¨åŠ è½½è”ç³»äºº...</option>
                        </select>
                        <div class="select-arrow">â–¼</div>
                    </div>
                </div>
                
                <div class="sms-conversation-container">
                    <div class="sms-conversation-header">
                        <span>çŸ­ä¿¡å¯¹è¯</span>
                        <div>
                            <button onclick="loadConversationHistory()" style="background:none; border:none; color:var(--text-secondary); font-size:12px; cursor:pointer; margin-right:10px;">
                                åˆ·æ–°
                            </button>
                            <button onclick="clearConversation()" style="background:none; border:none; color:var(--text-secondary); font-size:12px; cursor:pointer;">
                                æ¸…ç©º
                            </button>
                        </div>
                    </div>
                    <div class="sms-conversation" id="sms-conversation">
                        <div class="message received">
                            <div class="message-avatar">ğŸ¤–</div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">ç³»ç»Ÿ</span>
                                    <span class="message-time">14:30</span>
                                </div>
                                <div class="message-text">
                                    çŸ­ä¿¡åŠŸèƒ½å·²å°±ç»ªã€‚æ‚¨å‘é€çš„çŸ­ä¿¡å°†ç›´æ¥å‡ºç°åœ¨SillyTavernèŠå¤©ä¸­ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sms-input-area">
                    <textarea id="sms-input" placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆå°†ç›´æ¥å‘é€åˆ°SillyTavernèŠå¤©ï¼‰" rows="3"></textarea>
                    <div class="input-actions">
                        <div class="char-counter" id="char-counter">
                            <span id="char-count">0</span>/500
                        </div>
                        <button class="send-btn" id="send-btn" onclick="sendSMS()">
                            <span class="send-icon">âœˆï¸</span>
                            å‘é€åˆ°èŠå¤©
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è°ƒæ•´å¤§å°æ‰‹æŸ„ -->
        <div class="resize-handle" id="resize-handle"></div>
    </div>

    <script>
        // ================================
        // å…¨å±€å˜é‡
        // ================================
        let contacts = [];
        let isResizing = false;
        let lastHeight = 0;
        let aiResponseObserver = null;
        let smsHistory = {};
        let pendingMessages = {};
        
        // ================================
        // åˆå§‹åŒ–å‡½æ•°
        // ================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“± å‚¬çœ APPæ‰©å±•é¢æ¿æ­£åœ¨åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–UIäº‹ä»¶
            initUIEvents();
            
            // åˆå§‹åŒ–è§’è‰²æ•°æ®
            await initCharacters();
            
            // åˆå§‹åŒ–è°ƒæ•´å¤§å°åŠŸèƒ½
            initResizeHandle();
            
            console.log('âœ¨ æ‰©å±•é¢æ¿åˆå§‹åŒ–å®Œæˆ');
        });
        
        // ================================
        // è§’è‰²æ•°æ®ç®¡ç†
        // ================================
        async function initCharacters() {
            try {
                // ç­‰å¾…STInterfaceåŠ è½½
                await waitForSTInterface();
                
                // åŠ è½½è§’è‰²æ•°æ®
                await loadContacts();
                
                // åˆå§‹åŒ–çŸ­ä¿¡è”ç³»äººä¸‹æ‹‰æ¡†
                initSMSContacts();
                
                // å¼€å§‹ç›‘å¬AIå›å¤
                startListeningForAIResponses();
                
                // æ›´æ–°æœªè¯»æŒ‡ç¤ºå™¨
                updateUnreadIndicators();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–è§’è‰²å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½è§’è‰²æ•°æ®ï¼Œè¯·æ£€æŸ¥é…’é¦†åŠ©æ‰‹æ˜¯å¦å®‰è£…');
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                document.getElementById('contacts-list').innerHTML = `
                    <div class="info-placeholder">
                        <div class="placeholder-icon">âš ï¸</div>
                        <p>æ— æ³•åŠ è½½è§’è‰²æ•°æ®: ${error.message}</p>
                        <button class="btn-secondary" onclick="retryLoadContacts()" style="margin-top:10px; padding:8px 16px;">
                            é‡è¯•
                        </button>
                    </div>
                `;
            }
        }
        
        // ç­‰å¾…STInterfaceåŠ è½½
        function waitForSTInterface() {
            return new Promise((resolve, reject) => {
                if (window.STInterface) {
                    console.log('âœ… STInterfaceå·²åŠ è½½');
                    resolve();
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 20; // 10ç§’è¶…æ—¶
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.STInterface) {
                        clearInterval(checkInterval);
                        console.log('âœ… STInterfaceå·²åŠ è½½');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('âŒ STInterfaceåŠ è½½è¶…æ—¶');
                        reject(new Error('STInterfaceåŠ è½½è¶…æ—¶'));
                    }
                }, 500);
            });
        }
        
        // åŠ è½½è”ç³»äºº
        async function loadContacts() {
            console.log('ğŸ“‡ å¼€å§‹åŠ è½½è”ç³»äºº...');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingEl = document.getElementById('contacts-loading');
                if (loadingEl) {
                    loadingEl.querySelector('.loading-text').textContent = 'æ­£åœ¨ä»[initvar]å˜é‡åŠ è½½è§’è‰²...';
                }
                
                // ä»STInterfaceè·å–è§’è‰²
                if (window.STInterface && window.STInterface.getCharacters) {
                    contacts = await window.STInterface.getCharacters();
                    console.log(`âœ… æˆåŠŸåŠ è½½ ${contacts.length} ä¸ªè§’è‰²`);
                    
                    // æ¸²æŸ“è”ç³»äººåˆ—è¡¨
                    renderContacts();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateContactStats();
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æœªè¯»æ¶ˆæ¯
                    checkForUnreadMessages();
                    
                } else {
                    throw new Error('STInterface.getCharacters æ–¹æ³•ä¸å¯ç”¨');
                }
                
            } catch (error) {
                console.error('åŠ è½½è”ç³»äººå¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯
                document.getElementById('contacts-list').innerHTML = `
                    <div class="info-placeholder">
                        <div class="placeholder-icon">âš ï¸</div>
                        <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                        <button class="btn-secondary" onclick="retryLoadContacts()" style="margin-top:10px; padding:8px 16px;">
                            é‡è¯•
                        </button>
                    </div>
                `;
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateContactStats();
            }
        }
        
        // æ£€æŸ¥æœªè¯»æ¶ˆæ¯
        function checkForUnreadMessages() {
            if (window.STInterface && window.STInterface.SMSManager) {
                contacts.forEach(contact => {
                    const unreadCount = window.STInterface.SMSManager.getContactUnreadCount(contact.name);
                    if (unreadCount > 0) {
                        console.log(`ğŸ“± ${contact.name} æœ‰ ${unreadCount} æ¡æœªè¯»æ¶ˆæ¯`);
                    }
                });
            }
        }
        
        // é‡è¯•åŠ è½½è”ç³»äºº
        async function retryLoadContacts() {
            console.log('ğŸ”„ é‡è¯•åŠ è½½è”ç³»äºº...');
            await loadContacts();
        }
        
        // æ¸²æŸ“è”ç³»äººåˆ—è¡¨
        function renderContacts() {
            const list = document.getElementById('contacts-list');
            
            if (contacts.length === 0) {
                list.innerHTML = `
                    <div class="info-placeholder">
                        <div class="placeholder-icon">ğŸ“±</div>
                        <p>æ²¡æœ‰æ‰¾åˆ°è”ç³»äºº</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            contacts.forEach(contact => {
                const statusClass = contact.status === 'online' ? 'status-online' : 
                                  contact.status === 'busy' ? 'status-busy' : 'status-offline';
                const statusText = contact.status === 'online' ? 'åœ¨çº¿' :
                                  contact.status === 'busy' ? 'å¿™ç¢Œ' : 'ç¦»çº¿';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªè¯»æ¶ˆæ¯
                let hasUnread = false;
                let unreadCount = 0;
                if (window.STInterface && window.STInterface.SMSManager) {
                    unreadCount = window.STInterface.SMSManager.getContactUnreadCount(contact.name);
                    hasUnread = unreadCount > 0;
                }
                
                // æå–è§’è‰²å±æ€§ï¼ˆå¦‚æœæœ‰ï¼‰
                const metadataHTML = contact.metadata ? `
                    <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">
                        ${contact.metadata.å¥½æ„Ÿåº¦ !== undefined ? `å¥½æ„Ÿåº¦: ${contact.metadata.å¥½æ„Ÿåº¦}` : ''}
                        ${contact.metadata.è­¦æˆ’åº¦ !== undefined ? ` | è­¦æˆ’åº¦: ${contact.metadata.è­¦æˆ’åº¦}` : ''}
                    </div>
                ` : '';
                
                html += `
                    <div class="contact-item ${hasUnread ? 'has-unread' : ''}" onclick="startSMSWith('${contact.name}')" data-name="${contact.name.toLowerCase()}">
                        <div class="contact-avatar">${contact.avatar}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="contact-phone">${contact.phone}</div>
                            <div class="contact-status">
                                <span class="status-dot ${statusClass}"></span>
                                ${statusText}
                            </div>
                            ${metadataHTML}
                        </div>
                        ${hasUnread ? `<div class="contact-unread-badge">${unreadCount}</div>` : ''}
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        // æ›´æ–°è”ç³»äººç»Ÿè®¡
        function updateContactStats() {
            document.getElementById('contact-count').textContent = contacts.length;
            const onlineCount = contacts.filter(c => c.status === 'online').length;
            document.getElementById('online-count').textContent = onlineCount;
            
            // æ›´æ–°æœªè¯»æ€»æ•°
            if (window.STInterface && window.STInterface.SMSManager) {
                const totalUnread = window.STInterface.SMSManager.getTotalUnreadCount();
                document.getElementById('unread-count').textContent = totalUnread;
            }
        }
        
        // è¿‡æ»¤è”ç³»äºº
        function filterContacts() {
            const searchTerm = document.getElementById('contact-search').value.toLowerCase();
            const contactItems = document.querySelectorAll('.contact-item');
            
            let visibleCount = 0;
            
            contactItems.forEach(item => {
                const name = item.getAttribute('data-name');
                const text = item.textContent.toLowerCase();
                
                if (name.includes(searchTerm) || text.includes(searchTerm)) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // å¦‚æœæ²¡æœ‰å¯è§çš„è”ç³»äººï¼Œæ˜¾ç¤ºæç¤º
            if (visibleCount === 0 && searchTerm) {
                document.getElementById('contacts-list').innerHTML += `
                    <div class="info-placeholder" style="margin-top:20px;">
                        <div class="placeholder-icon">ğŸ”</div>
                        <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº</p>
                    </div>
                `;
            }
        }
        
        // ================================
        // çŸ­ä¿¡åŠŸèƒ½
        // ================================
        
        // åˆå§‹åŒ–çŸ­ä¿¡è”ç³»äººä¸‹æ‹‰æ¡†
        function initSMSContacts() {
            const select = document.getElementById('sms-contact');
            
            // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªï¼‰
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            if (contacts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æš‚æ— è”ç³»äºº';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            // æ·»åŠ åŠ¨æ€è§’è‰²é€‰é¡¹
            contacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.name;
                option.textContent = contact.name;
                option.setAttribute('data-avatar', contact.avatar);
                
                // å¦‚æœæœ‰æœªè¯»æ¶ˆæ¯ï¼Œåœ¨é€‰é¡¹åæ·»åŠ æ ‡è®°
                if (window.STInterface && window.STInterface.SMSManager) {
                    const unreadCount = window.STInterface.SMSManager.getContactUnreadCount(contact.name);
                    if (unreadCount > 0) {
                        option.textContent += ` (${unreadCount}æ¡æœªè¯»)`;
                    }
                }
                
                select.appendChild(option);
            });
        }
        
        // å¼€å§‹ä¸æŒ‡å®šè”ç³»äººå‘çŸ­ä¿¡
        function startSMSWith(name) {
            switchTab('sms');
            document.getElementById('sms-contact').value = name;
            document.getElementById('sms-input').focus();
            
            // æ ‡è®°è¯¥è”ç³»äººçš„æœªè¯»æ¶ˆæ¯ä¸ºå·²è¯»
            if (window.STInterface && window.STInterface.SMSManager) {
                const marked = window.STInterface.SMSManager.markAsRead(name);
                if (marked > 0) {
                    console.log(`ğŸ“± æ ‡è®°äº† ${marked} æ¡æ¶ˆæ¯ä¸ºå·²è¯»ï¼ˆ${name}ï¼‰`);
                    
                    // æ›´æ–°UI
                    updateUnreadIndicators();
                    loadConversationHistory();
                }
            }
            
            // åŠ è½½å¯¹è¯å†å²
            loadConversationHistory();
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯åˆ°å¯¹è¯
            addSystemMessage(`å·²é€‰æ‹©è”ç³»äºº: ${name}`);
        }
        
        // å‘é€çŸ­ä¿¡
        async function sendSMS() {
            const contact = document.getElementById('sms-contact').value;
            const message = document.getElementById('sms-input').value.trim();
            const conversation = document.getElementById('sms-conversation');
            
            if (!contact || contact === '') {
                addSystemMessage('è¯·å…ˆé€‰æ‹©è”ç³»äºº');
                return;
            }
            
            if (!message) {
                addSystemMessage('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            if (message.length > 500) {
                addSystemMessage('æ¶ˆæ¯é•¿åº¦ä¸èƒ½è¶…è¿‡500å­—ç¬¦');
                return;
            }
            
            // ç¦ç”¨å‘é€æŒ‰é’®
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="send-icon">â³</span>å‘é€ä¸­...';
            
            try {
                // 1. æ£€æŸ¥æ˜¯å¦æœ‰æœªè¯»çš„AIå›å¤
                let unreadMessages = [];
                if (window.STInterface && window.STInterface.SMSManager) {
                    unreadMessages = window.STInterface.SMSManager.getUnreadMessages(contact);
                }
                
                // 2. æ„å»ºå‘é€å†…å®¹
                let messageToSend = message;
                let hasUnread = false;
                
                if (unreadMessages.length > 0) {
                    // å¦‚æœæœ‰æœªè¯»æ¶ˆæ¯ï¼Œå°†å…¶åŒ…å«åœ¨å‘é€å†…å®¹ä¸­
                    hasUnread = true;
                    let unreadText = 'ã€æœªè¯»æ¶ˆæ¯ã€‘\n';
                    unreadMessages.forEach((msg, index) => {
                        unreadText += `${contact}ï¼ˆ${index + 1}æ¡å‰ï¼‰: ${msg.text}\n`;
                    });
                    unreadText += `\nã€æˆ‘çš„æ–°æ¶ˆæ¯ã€‘\n${message}`;
                    messageToSend = unreadText;
                    
                    // æ ‡è®°è¿™äº›æ¶ˆæ¯ä¸ºå·²è¯»
                    window.STInterface.SMSManager.markAsRead(contact);
                }
                
                // 3. æ·»åŠ åˆ°æœ¬åœ°å¯¹è¯æ˜¾ç¤º
                addSentMessage(message);
                
                // 4. å­˜å‚¨åˆ°çŸ­ä¿¡ç®¡ç†å™¨ï¼ˆç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼‰
                if (window.STInterface && window.STInterface.SMSManager) {
                    window.STInterface.SMSManager.addMessage(contact, message, true);
                }
                
                // 5. å‘é€åˆ°SillyTavern
                const result = await window.STInterface.sendUserMessage(messageToSend, {
                    contact: contact,
                    type: 'sms',
                    source: 'hypnosis_app',
                    containsUnread: hasUnread,
                    unreadCount: unreadMessages.length
                });
                
                if (result && result.success) {
                    console.log('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ');
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('sms-input').value = '';
                    document.getElementById('char-count').textContent = '0';
                    updateCharCounter();
                    
                    // æ·»åŠ å‘é€æˆåŠŸæç¤º
                    addSystemMessage(`æ¶ˆæ¯å·²å‘é€ç»™ ${contact}${hasUnread ? `ï¼ˆåŒ…å«${unreadMessages.length}æ¡æœªè¯»æ¶ˆæ¯ï¼‰` : ''}`);
                    
                    // æ›´æ–°æœªè¯»æŒ‡ç¤ºå™¨
                    updateUnreadIndicators();
                    
                } else {
                    console.error('âŒ æ¶ˆæ¯å‘é€å¤±è´¥');
                    addSystemMessage('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
                }
                
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™:', error);
                addSystemMessage(`å‘é€é”™è¯¯: ${error.message}`);
            } finally {
                // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span class="send-icon">âœˆï¸</span>å‘é€åˆ°èŠå¤©';
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        // æ·»åŠ å‘é€çš„æ¶ˆæ¯
        function addSentMessage(text, timestamp = null) {
            const conversation = document.getElementById('sms-conversation');
            const time = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 
                            new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ˜Š</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">æˆ‘</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(text)}</div>
                </div>
            `;
            
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const conversation = document.getElementById('sms-conversation');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">ç³»ç»Ÿ</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(text)}</div>
                </div>
            `;
            
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        // å¼€å§‹ç›‘å¬AIå›å¤
        function startListeningForAIResponses() {
            if (window.STInterface && window.STInterface.getCharacterResponse) {
                aiResponseObserver = window.STInterface.getCharacterResponse((response) => {
                    console.log('ğŸ“¥ æ”¶åˆ°AIå›å¤:', response.substring(0, 100));
                    
                    // è·å–å½“å‰é€‰ä¸­çš„è”ç³»äºº
                    const contact = document.getElementById('sms-contact').value;
                    
                    // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„è”ç³»äººï¼Œå°è¯•ä»å›å¤ä¸­æ¨æ–­
                    let targetContact = contact;
                    if (!targetContact) {
                        // å°è¯•ä»å›å¤ä¸­æ¨æ–­è”ç³»äºº
                        contacts.forEach(c => {
                            if (response.includes(c.name)) {
                                targetContact = c.name;
                            }
                        });
                    }
                    
                    if (targetContact) {
                        // 1. å­˜å‚¨åˆ°çŸ­ä¿¡ç®¡ç†å™¨ï¼ˆAIå‘é€çš„æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºæœªè¯»ï¼‰
                        if (window.STInterface && window.STInterface.SMSManager) {
                            window.STInterface.SMSManager.addMessage(targetContact, response, false);
                        }
                        
                        // 2. å¦‚æœå½“å‰æ­£åœ¨ä¸è¯¥è”ç³»äººå¯¹è¯ï¼Œæ·»åŠ åˆ°ç•Œé¢æ˜¾ç¤º
                        const currentContact = document.getElementById('sms-contact').value;
                        if (currentContact === targetContact) {
                            addReceivedMessage(targetContact, response);
                        }
                        
                        // 3. æ›´æ–°ç•Œé¢ä¸Šçš„æœªè¯»æŒ‡ç¤ºå™¨
                        updateUnreadIndicators();
                        
                        // 4. å¦‚æœå½“å‰ä¸åœ¨çŸ­ä¿¡æ ‡ç­¾é¡µï¼Œæ˜¾ç¤ºé€šçŸ¥
                        const smsTab = document.getElementById('sms-tab');
                        if (!smsTab.classList.contains('active')) {
                            // æŸ¥æ‰¾è”ç³»äººçš„å¤´åƒ
                            const contactObj = contacts.find(c => c.name === targetContact);
                            const avatar = contactObj ? contactObj.avatar : 'ğŸ‘¤';
                            showNotification(`ğŸ“± ${targetContact}: ${response.substring(0, 50)}...`, avatar);
                        }
                    }
                });
                console.log('ğŸ” å¼€å§‹ç›‘å¬AIå›å¤');
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, icon = 'ğŸ“±') {
            try {
                // åˆ›å»ºé€šçŸ¥å…ƒç´ 
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 16px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    max-width: 300px;
                    animation: slideIn 0.3s ease;
                    border-left: 4px solid var(--primary-color);
                `;
                
                notification.innerHTML = `
                    <div style="font-size:20px;">${icon}</div>
                    <div>
                        <div style="font-size:12px; font-weight:600; color:var(--primary-color);">æ–°æ¶ˆæ¯</div>
                        <div style="font-size:13px; color:var(--text-primary);">${message}</div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // 5ç§’åç§»é™¤
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }
                }, 5000);
                
                // æ·»åŠ åŠ¨ç”»æ ·å¼
                if (!document.querySelector('#notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'notification-styles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
            } catch (error) {
                console.warn('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:', error);
            }
        }
        
        // æ·»åŠ æ”¶åˆ°çš„æ¶ˆæ¯
        function addReceivedMessage(sender, text, timestamp = null, avatar = null, shouldStore = true) {
            const conversation = document.getElementById('sms-conversation');
            const time = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 
                            new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // æŸ¥æ‰¾å‘é€è€…çš„å¤´åƒ
            const contact = contacts.find(c => c.name === sender);
            const displayAvatar = avatar || (contact ? contact.avatar : 'ğŸ‘¤');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            messageDiv.innerHTML = `
                <div class="message-avatar">${displayAvatar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(text)}</div>
                </div>
            `;
            
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        // åŠ è½½å¯¹è¯å†å²
        function loadConversationHistory() {
            const contact = document.getElementById('sms-contact').value;
            const conversation = document.getElementById('sms-conversation');
            
            if (!contact || contact === '') {
                return;
            }
            
            if (window.STInterface && window.STInterface.SMSManager) {
                const history = window.STInterface.SMSManager.getConversation(contact, 50);
                
                // æ¸…ç©ºå½“å‰æ˜¾ç¤ºï¼ˆä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                conversation.innerHTML = '';
                
                // æ·»åŠ å†å²æ¶ˆæ¯
                if (history.length === 0) {
                    // å¦‚æœæ²¡æœ‰å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                    addSystemMessage(`å¼€å§‹ä¸ ${contact} çš„å¯¹è¯`);
                } else {
                    history.forEach(msg => {
                        if (msg.fromUser) {
                            addSentMessage(msg.text, msg.timestamp);
                        } else {
                            // æŸ¥æ‰¾è”ç³»äººçš„å¤´åƒ
                            const contactObj = contacts.find(c => c.name === contact);
                            const avatar = contactObj ? contactObj.avatar : 'ğŸ‘¤';
                            addReceivedMessage(contact, msg.text, msg.timestamp, avatar, false);
                        }
                    });
                }
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                conversation.scrollTop = conversation.scrollHeight;
            }
        }
        
        // æ¸…ç©ºå¯¹è¯
        function clearConversation() {
            const contact = document.getElementById('sms-contact').value;
            
            if (!contact || contact === '') {
                addSystemMessage('è¯·å…ˆé€‰æ‹©è”ç³»äºº');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºä¸ ${contact} çš„å¯¹è¯å†å²å—ï¼Ÿ`)) {
                if (window.STInterface && window.STInterface.SMSManager) {
                    window.STInterface.SMSManager.clearConversation(contact);
                }
                
                const conversation = document.getElementById('sms-conversation');
                conversation.innerHTML = `
                    <div class="message received">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">ç³»ç»Ÿ</span>
                                <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div class="message-text">å¯¹è¯å·²æ¸…ç©º</div>
                        </div>
                    </div>
                `;
                
                addSystemMessage(`å·²æ¸…ç©ºä¸ ${contact} çš„å¯¹è¯å†å²`);
            }
        }
        
        // æ›´æ–°æœªè¯»æŒ‡ç¤ºå™¨
        function updateUnreadIndicators() {
            if (window.STInterface && window.STInterface.SMSManager) {
                const totalUnread = window.STInterface.SMSManager.getTotalUnreadCount();
                
                // æ›´æ–°çŸ­ä¿¡æ ‡ç­¾çš„å¾½ç« 
                const smsTabBtn = document.getElementById('sms-tab-btn');
                updateTabBadge(smsTabBtn, totalUnread);
                
                // æ›´æ–°é€šè®¯å½•æ ‡ç­¾çš„å¾½ç« 
                const contactsTabBtn = document.getElementById('contacts-tab-btn');
                updateTabBadge(contactsTabBtn, totalUnread);
                
                // æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„æœªè¯»å¾½ç« 
                updateContactsUnreadBadges();
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateContactStats();
            }
        }
        
        // æ›´æ–°æ ‡ç­¾å¾½ç« 
        function updateTabBadge(tabElement, count) {
            if (!tabElement) return;
            
            const existingBadge = tabElement.querySelector('.unread-badge');
            
            if (count > 0) {
                if (existingBadge) {
                    existingBadge.textContent = count;
                } else {
                    const badge = document.createElement('span');
                    badge.className = 'unread-badge';
                    badge.textContent = count;
                    tabElement.style.position = 'relative';
                    tabElement.appendChild(badge);
                }
            } else if (existingBadge) {
                existingBadge.remove();
            }
        }
        
        // æ›´æ–°è”ç³»äººæœªè¯»å¾½ç« 
        function updateContactsUnreadBadges() {
            if (!window.STInterface || !window.STInterface.SMSManager) return;
            
            const contactItems = document.querySelectorAll('.contact-item');
            contactItems.forEach(item => {
                const name = item.getAttribute('data-name');
                if (name) {
                    const unreadCount = window.STInterface.SMSManager.getContactUnreadCount(name);
                    const existingBadge = item.querySelector('.contact-unread-badge');
                    
                    if (unreadCount > 0) {
                        item.classList.add('has-unread');
                        if (existingBadge) {
                            existingBadge.textContent = unreadCount;
                        } else {
                            const badge = document.createElement('div');
                            badge.className = 'contact-unread-badge';
                            badge.textContent = unreadCount;
                            item.appendChild(badge);
                        }
                    } else {
                        item.classList.remove('has-unread');
                        if (existingBadge) {
                            existingBadge.remove();
                        }
                    }
                }
            });
        }
        
        // ================================
        // åœ°å›¾åŠŸèƒ½
        // ================================
        function showLocationInfo(name, description) {
            document.getElementById('location-info').innerHTML = `
                <div>
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                        <span style="font-size:20px;">ğŸ“</span>
                        <h5 style="color:var(--primary-color);">${name}</h5>
                    </div>
                    <p style="font-size:13px; color:var(--text-secondary);">${description}</p>
                    <button class="btn-primary" onclick="travelToLocation('${name}')" style="margin-top:10px; width:100%;">
                        ğŸš¶ å‰å¾€æ­¤å¤„
                    </button>
                </div>
            `;
        }
        
        function travelToLocation(location) {
            if (window.STInterface && window.STInterface.sendUserMessage) {
                window.STInterface.sendUserMessage(`ï¼ˆç§»åŠ¨åˆ°${location}ï¼‰`, {
                    type: 'travel',
                    location: location
                });
                addSystemMessage(`å·²ç§»åŠ¨åˆ° ${location}`);
            } else {
                console.log('å‰å¾€:', location);
            }
        }
        
        function refreshMap() {
            console.log('åˆ·æ–°åœ°å›¾');
            showLocationInfo('åœ°å›¾å·²åˆ·æ–°', 'æ‰€æœ‰åœ°ç‚¹ä¿¡æ¯å·²æ›´æ–°');
        }
        
        function showAllLocations() {
            const locations = [
                { name: 'æ•™å­¦æ¥¼', desc: 'äºŒå¹´çº§æ•™å®¤ã€å›¾ä¹¦å®¤ã€ç”µè„‘å®¤' },
                { name: 'ä½“è‚²é¦†', desc: 'è¿åŠ¨åœºåœ°ï¼Œæ›´è¡£å®¤å’Œæ·‹æµ´é—´' },
                { name: 'æ—§æ ¡èˆ', desc: 'åˆä¼‘é¿éš¾æ‰€ï¼Œå®‰é™å°‘äºº' },
                { name: 'é£Ÿå ‚', desc: 'åˆé¤å’Œå°å–éƒ¨æ‰€åœ¨åœ°' }
            ];
            
            let html = '<div style="max-height:200px; overflow-y:auto;">';
            locations.forEach(loc => {
                html += `
                    <div style="padding:8px; border-bottom:1px solid var(--border-color);">
                        <div style="font-weight:600; color:var(--primary-color);">${loc.name}</div>
                        <div style="font-size:12px; color:var(--text-secondary);">${loc.desc}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            showLocationInfo('æ‰€æœ‰åœ°ç‚¹', 'æ ¡å›­å†…çš„æ‰€æœ‰é‡è¦åœ°ç‚¹');
            document.getElementById('location-info').innerHTML = html;
        }
        
        // ================================
        // UIæ§åˆ¶
        // ================================
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // å¦‚æœæ˜¯é€šè®¯å½•æ ‡ç­¾ï¼Œç¡®ä¿è”ç³»äººå·²åŠ è½½
            if (tabName === 'contacts' && contacts.length === 0) {
                loadContacts();
            }
            
            // å¦‚æœæ˜¯çŸ­ä¿¡æ ‡ç­¾ï¼ŒåŠ è½½å†å²è®°å½•
            if (tabName === 'sms') {
                loadConversationHistory();
                updateUnreadIndicators();
            }
        }
        
        function closeExtension() {
            if (window.parent && window.parent.document.getElementById('hypnosis-extension-iframe')) {
                window.parent.document.getElementById('hypnosis-extension-iframe').style.display = 'none';
            }
        }
        
        function showError(message) {
            console.error('é”™è¯¯:', message);
            
            // å°è¯•ä½¿ç”¨STInterfaceçš„é€šçŸ¥
            if (window.STInterface && window.STInterface.showNotification) {
                window.STInterface.showNotification(message, 'error');
            } else {
                // ç®€å•alertä½œä¸ºå›é€€
                alert(`é”™è¯¯: ${message}`);
            }
        }
        
        // ================================
        // è°ƒæ•´å¤§å°åŠŸèƒ½
        // ================================
        function initResizeHandle() {
            const resizeHandle = document.getElementById('resize-handle');
            const container = document.getElementById('hypnosis-extension');
            
            if (!resizeHandle || !container) return;
            
            resizeHandle.addEventListener('mousedown', startResize);
            
            function startResize(e) {
                e.preventDefault();
                isResizing = true;
                lastHeight = container.offsetHeight;
                
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                
                // æ”¹å˜å…‰æ ‡
                document.body.style.cursor = 'ns-resize';
                container.style.pointerEvents = 'none';
            }
            
            function handleResize(e) {
                if (!isResizing) return;
                
                const deltaY = e.movementY;
                const newHeight = Math.max(300, Math.min(800, lastHeight + deltaY));
                
                container.style.height = `${newHeight}px`;
                lastHeight = newHeight;
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
                
                // æ¢å¤å…‰æ ‡
                document.body.style.cursor = '';
                container.style.pointerEvents = '';
            }
        }
        
        // ================================
        // å·¥å…·å‡½æ•°
        // ================================
        function initUIEvents() {
            // å­—ç¬¦è®¡æ•°å™¨
            const smsInput = document.getElementById('sms-input');
            if (smsInput) {
                smsInput.addEventListener('input', updateCharCounter);
            }
            
            // å›è½¦é”®å‘é€ï¼ˆCtrl+Enterï¼‰
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.id === 'sms-input') {
                        sendSMS();
                    }
                }
            });
            
            // è”ç³»äººé€‰æ‹©å˜åŒ–æ—¶åŠ è½½å†å²è®°å½•
            const smsContactSelect = document.getElementById('sms-contact');
            if (smsContactSelect) {
                smsContactSelect.addEventListener('change', function() {
                    const contact = this.value;
                    if (contact) {
                        // æ ‡è®°è¯¥è”ç³»äººçš„æœªè¯»æ¶ˆæ¯ä¸ºå·²è¯»
                        if (window.STInterface && window.STInterface.SMSManager) {
                            window.STInterface.SMSManager.markAsRead(contact);
                            updateUnreadIndicators();
                        }
                        loadConversationHistory();
                    }
                });
            }
        }
        
        function updateCharCounter() {
            const textarea = document.getElementById('sms-input');
            const charCount = document.getElementById('char-count');
            const counter = document.getElementById('char-counter');
            
            if (!textarea || !charCount || !counter) return;
            
            const count = textarea.value.length;
            charCount.textContent = count;
            
            // æ›´æ–°é¢œè‰²
            counter.className = 'char-counter';
            if (count > 450) {
                counter.classList.add('warning');
            }
            if (count > 500) {
                counter.classList.add('error');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ================================
        // è°ƒè¯•åŠŸèƒ½
        // ================================
        window.debugExtension = function() {
            console.group('ğŸ”§ æ‰©å±•è°ƒè¯•ä¿¡æ¯');
            console.log('è”ç³»äººæ•°é‡:', contacts.length);
            console.log('è”ç³»äºº:', contacts);
            console.log('STInterfaceå¯ç”¨:', !!window.STInterface);
            
            if (window.STInterface && window.STInterface.runDiagnostics) {
                console.log('è¯Šæ–­ç»“æœ:');
                console.dir(window.STInterface.runDiagnostics());
            }
            
            if (window.STInterface && window.STInterface.SMSManager) {
                console.log('çŸ­ä¿¡å­˜å‚¨:', {
                    contacts: Object.keys(window.STInterface.SMSManager.storage).length,
                    totalUnread: window.STInterface.SMSManager.getTotalUnreadCount()
                });
            }
            
            console.groupEnd();
        };
        
        // å¯¼å‡ºçŸ­ä¿¡æ•°æ®
        window.exportSMSData = function() {
            if (window.STInterface && window.STInterface.exportSMSData) {
                window.STInterface.exportSMSData();
            } else {
                alert('å¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨');
            }
        };
        
        // é‡ç½®çŸ­ä¿¡æ•°æ®
        window.resetSMSData = function() {
            if (window.STInterface && window.STInterface.resetSMSStorage) {
                window.STInterface.resetSMSStorage();
                updateUnreadIndicators();
                loadContacts();
            } else {
                alert('é‡ç½®åŠŸèƒ½ä¸å¯ç”¨');
            }
        };
    </script>
</body>
</html>
