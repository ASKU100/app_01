<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚¬çœ APP - æ‰©å±•åŠŸèƒ½</title>
    <style>
        /* æ‰©å±•é¢æ¿æ ·å¼ */
        #hypnosis-extension {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 400px;
            height: 600px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .extension-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .extension-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: white;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            padding: 20px;
            height: calc(100% - 130px);
            overflow-y: auto;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .toggle-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- åˆ‡æ¢æŒ‰é’® -->
    <button class="toggle-button" onclick="toggleExtension()">ğŸ“±</button>
    
    <!-- æ‰©å±•é¢æ¿ -->
    <div id="hypnosis-extension">
        <div class="extension-header">
            <h3 style="margin: 0;">å‚¬çœ APPæ‰©å±•åŠŸèƒ½</h3>
            <button onclick="closeExtension()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">Ã—</button>
        </div>
        
        <div class="extension-tabs">
            <button class="tab-button active" onclick="switchTab('map')">ğŸ—ºï¸ åœ°å›¾</button>
            <button class="tab-button" onclick="switchTab('contacts')">ğŸ“ é€šè®¯å½•</button>
            <button class="tab-button" onclick="switchTab('sms')">ğŸ’¬ çŸ­ä¿¡</button>
        </div>
        
        <!-- åœ°å›¾æ ‡ç­¾é¡µ -->
        <div id="map-tab" class="tab-content active">
            <h4>ç§ç«‹æ–‹æ˜å­¦å›­åœ°å›¾</h4>
            <div id="map-container" style="height: 400px; border: 1px solid #ccc; margin-top: 15px; background: #e9f4ff;">
                <!-- è¿™é‡Œä¼šåŠ¨æ€åŠ è½½åœ°å›¾ -->
                <div style="padding: 20px; text-align: center;">
                    <p>åœ°å›¾åŠ è½½ä¸­...</p>
                    <button onclick="loadSchoolMap()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        åŠ è½½æ ¡å›­åœ°å›¾
                    </button>
                </div>
            </div>
            <div id="location-info" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
        </div>
        
        <!-- é€šè®¯å½•æ ‡ç­¾é¡µ -->
        <div id="contacts-tab" class="tab-content">
            <h4>é€šè®¯å½•</h4>
            <div id="contacts-list" style="margin-top: 15px;">
                <!-- è”ç³»äººåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                <p>æ­£åœ¨åŠ è½½è”ç³»äºº...</p>
            </div>
        </div>
        
        <!-- çŸ­ä¿¡æ ‡ç­¾é¡µ -->
        <div id="sms-tab" class="tab-content">
            <h4>çŸ­ä¿¡</h4>
            <div id="sms-conversation" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; background: #fff;">
                <!-- çŸ­ä¿¡å¯¹è¯å†…å®¹ -->
                <div class="message received">
                    <strong>ç³»ç»Ÿï¼š</strong> çŸ­ä¿¡åŠŸèƒ½å·²å°±ç»ªã€‚æ‚¨å¯ä»¥å‘è§’è‰²å‘é€çŸ­ä¿¡ã€‚
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <select id="sms-contact" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">é€‰æ‹©è”ç³»äºº</option>
                    <!-- è”ç³»äººé€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                </select>
                <button onclick="sendSMS()" style="padding: 8px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    å‘é€
                </button>
            </div>
            
            <textarea id="sms-input" placeholder="è¾“å…¥çŸ­ä¿¡å†…å®¹..." 
                      style="width: 100%; height: 80px; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
            
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                <p>ğŸ’¡ æç¤ºï¼šå‘é€çŸ­ä¿¡å°†è§¦å‘è§’è‰²å›å¤ï¼Œæ˜¾ç¤ºåœ¨å¯¹è¯ä¸­</p>
            </div>
        </div>
    </div>

    <script>
        // æ‰©å±•é¢æ¿æ§åˆ¶
        function toggleExtension() {
            const panel = document.getElementById('hypnosis-extension');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        
        function closeExtension() {
            document.getElementById('hypnosis-extension').style.display = 'none';
        }
        
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»å½“å‰æ ‡ç­¾
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'map') loadSchoolMap();
            if (tabName === 'contacts') loadContacts();
            if (tabName === 'sms') loadSMSContacts();
        }
        
        // åœ°å›¾åŠŸèƒ½
        function loadSchoolMap() {
            const container = document.getElementById('map-container');
            const info = document.getElementById('location-info');
            
            // ä½¿ç”¨ç®€å•çš„HTMLåœ°å›¾ï¼ˆé¿å…å¤–éƒ¨APIä¾èµ–ï¼‰
            container.innerHTML = `
                <div style="position: relative; height: 100%;">
                    <img src="https://via.placeholder.com/380x380/e9f4ff/667eea?text=ç§ç«‹æ–‹æ˜å­¦å›­åœ°å›¾" 
                         style="width: 100%; height: 100%; object-fit: contain;" alt="æ ¡å›­åœ°å›¾">
                    
                    <!-- å¯ç‚¹å‡»çš„åœ°ç‚¹æ ‡è®° -->
                    <div style="position: absolute; top: 30%; left: 40%; width: 20px; height: 20px; background: red; border-radius: 50%; cursor: pointer;"
                         onclick="showLocationInfo('æ•™å­¦æ¥¼', 'äºŒå¹´çº§æ•™å®¤ã€å›¾ä¹¦å®¤ã€ç”µè„‘å®¤æ‰€åœ¨å¤„')"></div>
                    <div style="position: absolute; top: 60%; left: 20%; width: 20px; height: 20px; background: blue; border-radius: 50%; cursor: pointer;"
                         onclick="showLocationInfo('ä½“è‚²é¦†', 'è¿åŠ¨åœºåœ°ï¼Œæ›´è¡£å®¤å’Œæ·‹æµ´é—´')"></div>
                    <div style="position: absolute; top: 40%; left: 70%; width: 20px; height: 20px; background: green; border-radius: 50%; cursor: pointer;"
                         onclick="showLocationInfo('æ—§æ ¡èˆ', 'åˆä¼‘é¿éš¾æ‰€ï¼Œå®‰é™å°‘äºº')"></div>
                </div>
            `;
            
            info.innerHTML = `<p>ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°æŸ¥çœ‹åœ°ç‚¹ä¿¡æ¯</p>`;
        }
        
        function showLocationInfo(name, description) {
            document.getElementById('location-info').innerHTML = `
                <h5>ğŸ“ ${name}</h5>
                <p>${description}</p>
                <button onclick="travelToLocation('${name}')" style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    å‰å¾€æ­¤å¤„
                </button>
            `;
        }
        
        function travelToLocation(locationName) {
            // ä¸SillyTaverné€šä¿¡ï¼šè§¦å‘åœ°ç‚¹åˆ‡æ¢
            if (window.STInterface) {
                window.STInterface.sendUserMessage(`ï¼ˆç§»åŠ¨åˆ°${locationName}ï¼‰`);
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥è®¾ç½®å˜é‡
                console.log(`ç©å®¶ç§»åŠ¨åˆ°: ${locationName}`);
            }
        }
        
        // é€šè®¯å½•åŠŸèƒ½
        function loadContacts() {
            const contactsList = document.getElementById('contacts-list');
            
            // ä»è§’è‰²å¡æ•°æ®ä¸­è·å–è§’è‰²ä¿¡æ¯
            const characters = [
                { name: 'è¥¿å›­å¯ºçˆ±ä¸½è', phone: '090-XXXX-0001', status: 'åœ¨çº¿', avatar: 'ğŸ‘‘' },
                { name: 'æœˆå’æ·±é›ª', phone: '090-XXXX-0002', status: 'åœ¨çº¿', avatar: 'â„ï¸' },
                { name: 'çŠ¬å†¢å¤ç¾', phone: '090-XXXX-0003', status: 'è®­ç»ƒä¸­', avatar: 'ğŸ•' },
                { name: 'é˜¿å®…å›', phone: '090-XXXX-0004', status: 'ç¦»çº¿', avatar: 'ğŸ‘“' }
            ];
            
            contactsList.innerHTML = characters.map(char => `
                <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" 
                     onclick="startSMSWith('${char.name}')">
                    <div style="font-size: 24px; margin-right: 15px;">${char.avatar}</div>
                    <div style="flex: 1;">
                        <strong>${char.name}</strong>
                        <div style="font-size: 12px; color: #666;">${char.phone}</div>
                    </div>
                    <div style="font-size: 12px; color: ${char.status === 'åœ¨çº¿' ? '#4CAF50' : '#999'}">
                        ${char.status}
                    </div>
                </div>
            `).join('');
        }
        
        // çŸ­ä¿¡åŠŸèƒ½
        function loadSMSContacts() {
            const select = document.getElementById('sms-contact');
            const characters = ['è¥¿å›­å¯ºçˆ±ä¸½è', 'æœˆå’æ·±é›ª', 'çŠ¬å†¢å¤ç¾', 'é˜¿å®…å›'];
            
            select.innerHTML = '<option value="">é€‰æ‹©è”ç³»äºº</option>' + 
                characters.map(char => `<option value="${char}">${char}</option>`).join('');
        }
        
        function sendSMS() {
            const contact = document.getElementById('sms-contact').value;
            const message = document.getElementById('sms-input').value.trim();
            const conversation = document.getElementById('sms-conversation');
            
            if (!contact) {
                alert('è¯·é€‰æ‹©è”ç³»äºº');
                return;
            }
            
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            // æ˜¾ç¤ºå‘é€çš„æ¶ˆæ¯
            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            messageElement.innerHTML = `<strong>æˆ‘ â†’ ${contact}ï¼š</strong> ${message}`;
            messageElement.style.textAlign = 'right';
            messageElement.style.color = '#067df7';
            conversation.appendChild(messageElement);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('sms-input').value = '';
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            conversation.scrollTop = conversation.scrollHeight;
            
            // å‘é€åˆ°SillyTavernè§¦å‘AIå›å¤
            sendToSillyTavern(`${contact}ï¼Œ${message}`);
            
            // æ¨¡æ‹Ÿå›å¤ï¼ˆå®é™…ç”±SillyTavernå¤„ç†ï¼‰
            setTimeout(() => {
                const replyElement = document.createElement('div');
                replyElement.className = 'message received';
                replyElement.innerHTML = `<strong>${contact} â†’ æˆ‘ï¼š</strong> æ­£åœ¨æ€è€ƒä¸­...`;
                replyElement.style.textAlign = 'left';
                replyElement.style.color = '#333';
                conversation.appendChild(replyElement);
                conversation.scrollTop = conversation.scrollHeight;
            }, 1000);
        }
        
        function startSMSWith(contactName) {
            // åˆ‡æ¢åˆ°çŸ­ä¿¡æ ‡ç­¾é¡µ
            switchTab('sms');
            
            // è®¾ç½®è”ç³»äºº
            setTimeout(() => {
                document.getElementById('sms-contact').value = contactName;
                document.getElementById('sms-input').focus();
            }, 100);
        }
        
        // ä¸SillyTavernçš„é€šä¿¡æ¥å£
        function sendToSillyTavern(message) {
            // æ–¹æ³•1ï¼šé€šè¿‡SillyTavernçš„æ‰©å±•API
            if (typeof window.STExtensionAPI !== 'undefined') {
                window.STExtensionAPI.sendMessage(message);
            }
            // æ–¹æ³•2ï¼šé€šè¿‡å…¨å±€äº‹ä»¶
            else if (typeof window.dispatchEvent !== 'undefined') {
                const event = new CustomEvent('hypnosis-sms', { 
                    detail: { message: message, timestamp: new Date() }
                });
                window.dispatchEvent(event);
            }
            // æ–¹æ³•3ï¼šé€šè¿‡æ§åˆ¶å°æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
            else {
                console.log('[SMSå‘é€åˆ°ST]:', message);
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadContacts();
            loadSMSContacts();
            
            // ç›‘å¬æ¥è‡ªSillyTavernçš„å›å¤
            window.addEventListener('hypnosis-sms-reply', (event) => {
                const { contact, message } = event.detail;
                const conversation = document.getElementById('sms-conversation');
                
                const replyElement = document.createElement('div');
                replyElement.className = 'message received';
                replyElement.innerHTML = `<strong>${contact} â†’ æˆ‘ï¼š</strong> ${message}`;
                replyElement.style.textAlign = 'left';
                replyElement.style.color = '#333';
                conversation.appendChild(replyElement);
                conversation.scrollTop = conversation.scrollHeight;
            });
        });
    </script>
</body>
</html>