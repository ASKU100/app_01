<!-- åˆ é™¤æ‰€æœ‰åŸæ¥çš„å†…å®¹ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç  -->
<div id="hypnosis-extension">
  <!-- å¤´éƒ¨ -->
  <div class="extension-header">
    <div class="header-left">
      <div class="app-icon">âœ¨</div>
      <div class="app-title">
        <h3>å‚¬çœ APPæ‰©å±•</h3>
        <p class="app-subtitle">å¢å¼ºåŠŸèƒ½é¢æ¿</p>
      </div>
    </div>
    <div class="header-right">
      <button class="close-btn" onclick="closeExtension()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- æ ‡ç­¾é¡µ -->
  <div class="extension-tabs">
    <button class="tab-button active" onclick="switchTab('map')">
      <span class="tab-icon">ğŸ—ºï¸</span>
      <span class="tab-label">åœ°å›¾</span>
    </button>
    <button class="tab-button" onclick="switchTab('contacts')">
      <span class="tab-icon">ğŸ“</span>
      <span class="tab-label">é€šè®¯å½•</span>
    </button>
    <button class="tab-button" onclick="switchTab('sms')">
      <span class="tab-icon">ğŸ’¬</span>
      <span class="tab-label">çŸ­ä¿¡</span>
    </button>
  </div>

  <!-- åœ°å›¾æ ‡ç­¾é¡µ -->
  <div id="map-tab" class="tab-content active">
    <div class="tab-header">
      <h4 class="tab-title">ç§ç«‹æ–‹æ˜å­¦å›­åœ°å›¾</h4>
      <p class="tab-description">æ¢ç´¢æ ¡å›­å„ä¸ªåœ°ç‚¹ï¼Œå¿«é€Ÿç§»åŠ¨</p>
    </div>
    
    <div class="map-container">
      <div class="map-preview">
        <div class="map-grid">
          <!-- åœ°å›¾æ ‡è®° -->
          <div class="map-marker" style="top: 30%; left: 40%;" data-location="æ•™å­¦æ¥¼" data-description="äºŒå¹´çº§æ•™å®¤ã€å›¾ä¹¦å®¤ã€ç”µè„‘å®¤">
            <div class="marker-dot"></div>
            <div class="marker-tooltip">ğŸ« æ•™å­¦æ¥¼</div>
          </div>
          <div class="map-marker" style="top: 60%; left: 20%;" data-location="ä½“è‚²é¦†" data-description="è¿åŠ¨åœºåœ°ï¼Œæ›´è¡£å®¤å’Œæ·‹æµ´é—´">
            <div class="marker-dot"></div>
            <div class="marker-tooltip">âš½ ä½“è‚²é¦†</div>
          </div>
          <div class="map-marker" style="top: 40%; left: 70%;" data-location="æ—§æ ¡èˆ" data-description="åˆä¼‘é¿éš¾æ‰€ï¼Œå®‰é™å°‘äºº">
            <div class="marker-dot"></div>
            <div class="marker-tooltip">ğŸšï¸ æ—§æ ¡èˆ</div>
          </div>
        </div>
      </div>
      
      <div class="location-info" id="location-info">
        <div class="info-placeholder">
          <div class="placeholder-icon">ğŸ“</div>
          <p>ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°æŸ¥çœ‹åœ°ç‚¹è¯¦æƒ…</p>
        </div>
      </div>
    </div>
    
    <div class="map-actions">
      <button class="btn-primary" onclick="refreshMap()">
        <span class="btn-icon">ğŸ”„</span>
        åˆ·æ–°åœ°å›¾
      </button>
      <button class="btn-secondary" onclick="showAllLocations()">
        <span class="btn-icon">ğŸ“‹</span>
        æ‰€æœ‰åœ°ç‚¹
      </button>
    </div>
  </div>

  <!-- é€šè®¯å½•æ ‡ç­¾é¡µ -->
  <div id="contacts-tab" class="tab-content">
    <div class="tab-header">
      <h4 class="tab-title">é€šè®¯å½•</h4>
      <p class="tab-description">è”ç³»æ ¡å›­ä¸­çš„è§’è‰²</p>
    </div>
    
    <div class="search-box">
      <div class="search-icon">ğŸ”</div>
      <input type="text" id="contact-search" placeholder="æœç´¢è”ç³»äºº..." oninput="filterContacts()">
      <button class="search-clear" onclick="clearSearch()">Ã—</button>
    </div>
    
    <div class="contacts-list" id="contacts-list">
      <!-- è”ç³»äººåˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="contacts-stats">
      <span class="stat-item">
        <span class="stat-label">è”ç³»äºº</span>
        <span class="stat-value" id="contact-count">4</span>
      </span>
      <span class="stat-item">
        <span class="stat-label">åœ¨çº¿</span>
        <span class="stat-value" id="online-count">2</span>
      </span>
    </div>
  </div>

  <!-- çŸ­ä¿¡æ ‡ç­¾é¡µ -->
  <div id="sms-tab" class="tab-content">
    <div class="tab-header">
      <h4 class="tab-title">çŸ­ä¿¡</h4>
      <p class="tab-description">ä¸è§’è‰²å‘é€æ¶ˆæ¯</p>
    </div>
    
    <div class="sms-recipient">
      <div class="recipient-select">
        <div class="select-icon">ğŸ‘¤</div>
        <select id="sms-contact">
          <option value="">é€‰æ‹©è”ç³»äºº</option>
          <option value="è¥¿å›­å¯ºçˆ±ä¸½è">è¥¿å›­å¯ºçˆ±ä¸½è</option>
          <option value="æœˆå’æ·±é›ª">æœˆå’æ·±é›ª</option>
          <option value="çŠ¬å†¢å¤ç¾">çŠ¬å†¢å¤ç¾</option>
          <option value="é˜¿å®…å›">é˜¿å®…å›</option>
        </select>
        <div class="select-arrow">â–¼</div>
      </div>
      <div class="recipient-info" id="recipient-info">
        <span class="recipient-status offline">ç¦»çº¿</span>
      </div>
    </div>
    
    <div class="sms-conversation" id="sms-conversation">
      <div class="message-date">ä»Šå¤©</div>
      <div class="message received">
        <div class="message-avatar">ğŸ¤–</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-sender">ç³»ç»Ÿ</span>
            <span class="message-time">14:30</span>
          </div>
          <div class="message-text">
            çŸ­ä¿¡åŠŸèƒ½å·²å°±ç»ªã€‚æ‚¨å¯ä»¥å‘è§’è‰²å‘é€çŸ­ä¿¡ï¼Œä»–ä»¬ä¼šå›å¤æ‚¨ã€‚
          </div>
        </div>
      </div>
    </div>
    
    <div class="sms-input-area">
      <div class="input-tools">
        <button class="input-tool" onclick="addEmoji()">ğŸ˜Š</button>
        <button class="input-tool" onclick="attachFile()">ğŸ“</button>
      </div>
      <textarea id="sms-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="3"></textarea>
      <div class="input-actions">
        <div class="char-counter">
          <span id="char-count">0</span>/500
        </div>
        <button class="send-btn" onclick="sendSMS()">
          <span class="send-icon">âœˆï¸</span>
          å‘é€
        </button>
      </div>
    </div>
    
    <div class="sms-tips">
      <div class="tip-icon">ğŸ’¡</div>
      <p>å‘é€çŸ­ä¿¡å°†è§¦å‘è§’è‰²åœ¨SillyTavernä¸­å›å¤</p>
    </div>
  </div>
</div>

<style>
  /* ====== å…¨å±€æ ·å¼ ====== */
  :root {
    --primary-color: #667eea;
    --primary-dark: #5a67d8;
    --secondary-color: #764ba2;
    --success-color: #48bb78;
    --warning-color: #ed8936;
    --danger-color: #f56565;
    --info-color: #4299e1;
    
    --bg-primary: #f7fafc;
    --bg-secondary: #edf2f7;
    --bg-card: #ffffff;
    --bg-hover: #f1f5f9;
    
    --text-primary: #2d3748;
    --text-secondary: #718096;
    --text-muted: #a0aec0;
    
    --border-color: #e2e8f0;
    --border-radius: 12px;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  #hypnosis-extension {
    width: 420px;
    height: 640px;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg), 0 20px 80px rgba(102, 126, 234, 0.15);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
    border: 1px solid var(--border-color);
  }

  /* ====== å¤´éƒ¨æ ·å¼ ====== */
  .extension-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    padding: 18px 24px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  .extension-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 14px;
    position: relative;
    z-index: 2;
  }

  .app-icon {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .app-title h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 2px;
    letter-spacing: 0.3px;
  }

  .app-subtitle {
    font-size: 12px;
    opacity: 0.9;
    font-weight: 400;
  }

  .close-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    color: white;
    position: relative;
    z-index: 2;
  }

  .close-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
  }

  /* ====== æ ‡ç­¾é¡µæ ·å¼ ====== */
  .extension-tabs {
    display: flex;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 8px 16px 0;
  }

  .tab-button {
    flex: 1;
    background: none;
    border: none;
    padding: 14px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    position: relative;
    transition: all var(--transition-fast);
    border-radius: 8px 8px 0 0;
  }

  .tab-button:hover {
    color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
  }

  .tab-button.active {
    color: var(--primary-color);
    background: var(--bg-card);
  }

  .tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 8px;
    right: 8px;
    height: 3px;
    background: var(--primary-color);
    border-radius: 2px 2px 0 0;
  }

  .tab-icon {
    font-size: 18px;
    line-height: 1;
  }

  .tab-label {
    font-size: 12px;
    letter-spacing: 0.3px;
  }

  /* ====== æ ‡ç­¾é¡µå†…å®¹æ ·å¼ ====== */
  .tab-content {
    flex: 1;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }

  .tab-content.active {
    display: flex;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .tab-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border-color);
  }

  .tab-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .tab-description {
    font-size: 13px;
    color: var(--text-secondary);
  }

  /* ====== åœ°å›¾æ ‡ç­¾é¡µæ ·å¼ ====== */
  .map-container {
    flex: 1;
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .map-preview {
    flex: 1;
    background: linear-gradient(135deg, #e9f4ff 0%, #f0f7ff 100%);
    border-radius: var(--border-radius);
    border: 2px solid #dbeafe;
    position: relative;
    overflow: hidden;
  }

  .map-grid {
    width: 100%;
    height: 100%;
    background-image: 
      linear-gradient(rgba(147, 197, 253, 0.2) 1px, transparent 1px),
      linear-gradient(90deg, rgba(147, 197, 253, 0.2) 1px, transparent 1px);
    background-size: 30px 30px;
    position: relative;
  }

  .map-marker {
    position: absolute;
    width: 40px;
    height: 40px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 2;
  }

  .marker-dot {
    width: 20px;
    height: 20px;
    background: var(--primary-color);
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 3px solid white;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-fast);
  }

  .map-marker:hover .marker-dot {
    transform: translate(-50%, -50%) scale(1.3);
    background: var(--danger-color);
  }

  .marker-tooltip {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: var(--shadow-md);
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all var(--transition-fast);
    border: 1px solid var(--border-color);
    z-index: 10;
  }

  .map-marker:hover .marker-tooltip {
    opacity: 1;
    top: -45px;
  }

  .location-info {
    min-height: 100px;
    background: var(--bg-primary);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    padding: 16px;
  }

  .info-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    text-align: center;
  }

  .placeholder-icon {
    font-size: 32px;
    margin-bottom: 12px;
    opacity: 0.6;
  }

  .map-actions {
    display: flex;
    gap: 12px;
  }

  /* ====== é€šè®¯å½•æ ‡ç­¾é¡µæ ·å¼ ====== */
  .search-box {
    position: relative;
    margin: 20px 24px;
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 14px;
    z-index: 2;
  }

  .search-box input {
    width: 100%;
    padding: 14px 16px 14px 42px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 14px;
    transition: all var(--transition-fast);
    background: var(--bg-card);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .search-clear {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 20px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all var(--transition-fast);
  }

  .search-clear:hover {
    background: var(--bg-hover);
    color: var(--danger-color);
  }

  .contacts-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 24px;
  }

  .contact-item {
    display: flex;
    align-items: center;
    padding: 14px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: 8px;
  }

  .contact-item:hover {
    background: var(--bg-hover);
    transform: translateX(4px);
  }

  .contact-avatar {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    margin-right: 14px;
    flex-shrink: 0;
  }

  .contact-info {
    flex: 1;
    min-width: 0;
  }

  .contact-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
    font-size: 14px;
  }

  .contact-phone {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .contact-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 500;
    padding: 4px 10px;
    border-radius: 20px;
    background: var(--bg-secondary);
    width: fit-content;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .status-online {
    background: var(--success-color);
  }

  .status-offline {
    background: var(--text-muted);
  }

  .status-busy {
    background: var(--warning-color);
  }

  .contacts-stats {
    display: flex;
    justify-content: space-between;
    padding: 16px 24px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-primary);
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-color);
  }

  /* ====== çŸ­ä¿¡æ ‡ç­¾é¡µæ ·å¼ ====== */
  .sms-recipient {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border-color);
  }

  .recipient-select {
    position: relative;
    margin-bottom: 8px;
  }

  .select-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    z-index: 2;
  }

  .recipient-select select {
    width: 100%;
    padding: 14px 16px 14px 42px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 14px;
    background: var(--bg-card);
    appearance: none;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .recipient-select select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .select-arrow {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    pointer-events: none;
    font-size: 12px;
  }

  .recipient-info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }

  .recipient-status {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.3px;
  }

  .online {
    background: rgba(72, 187, 120, 0.1);
    color: var(--success-color);
  }

  .offline {
    background: rgba(160, 174, 192, 0.1);
    color: var(--text-muted);
  }

  .sms-conversation {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
    background: var(--bg-primary);
  }

  .message-date {
    text-align: center;
    font-size: 11px;
    color: var(--text-muted);
    padding: 8px;
    position: relative;
    margin: 16px 0;
  }

  .message-date::before,
  .message-date::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 30%;
    height: 1px;
    background: var(--border-color);
  }

  .message-date::before {
    left: 0;
  }

  .message-date::after {
    right: 0;
  }

  .message {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    animation: slideIn 0.3s ease;
  }

  .message.received {
    flex-direction: row;
  }

  .message.sent {
    flex-direction: row-reverse;
  }

  .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .message.received .message-avatar {
    background: linear-gradient(135deg, #edf2f7, #e2e8f0);
  }

  .message.sent .message-avatar {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
  }

  .message-content {
    max-width: 70%;
    background: white;
    border-radius: 18px;
    padding: 12px 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }

  .message.received .message-content {
    border-top-left-radius: 4px;
  }

  .message.sent .message-content {
    border-top-right-radius: 4px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
  }

  .message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
    font-size: 11px;
  }

  .message.sent .message-header {
    color: rgba(255, 255, 255, 0.8);
  }

  .message-text {
    font-size: 13px;
    line-height: 1.5;
  }

  .sms-input-area {
    border-top: 1px solid var(--border-color);
    padding: 16px 24px;
    background: var(--bg-card);
  }

  .input-tools {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  .input-tool {
    background: none;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 14px;
    transition: all var(--transition-fast);
  }

  .input-tool:hover {
    background: var(--bg-hover);
    transform: scale(1.1);
  }

  .sms-input-area textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 14px;
    resize: none;
    transition: all var(--transition-fast);
    background: var(--bg-card);
  }

  .sms-input-area textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .input-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }

  .char-counter {
    font-size: 12px;
    color: var(--text-muted);
  }

  .send-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all var(--transition-fast);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
  }

  .send-btn:active {
    transform: translateY(0);
  }

  .sms-tips {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: rgba(102, 126, 234, 0.05);
    border-top: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--text-secondary);
  }

  .tip-icon {
    font-size: 14px;
  }

  /* ====== æŒ‰é’®æ ·å¼ ====== */
  .btn-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all var(--transition-fast);
    flex: 1;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
  }

  .btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 12px 20px;
    border-radius: var(--border-radius);
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all var(--transition-fast);
    flex: 1;
  }

  .btn-secondary:hover {
    background: var(--bg-hover);
    border-color: var(--primary-color);
  }

  .btn-icon {
    font-size: 14px;
  }

  /* ====== æ»šåŠ¨æ¡æ ·å¼ ====== */
  ::-webkit-scrollbar {
    width: 6px;
  }

  ::-webkit-scrollbar-track {
    background: transparent;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
  }

  /* ====== å“åº”å¼è°ƒæ•´ ====== */
  @media (max-height: 700px) {
    #hypnosis-extension {
      height: 580px;
    }
    
    .tab-header {
      padding: 16px 20px 12px;
    }
    
    .map-container,
    .sms-conversation {
      padding: 16px 20px;
    }
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }
</style>

<script>
  // ====== å…¨å±€å˜é‡ ======
  let currentTab = 'map';
  let contacts = [
    {
      name: 'è¥¿å›­å¯ºçˆ±ä¸½è',
      phone: '090-XXXX-0001',
      status: 'online',
      avatar: 'ğŸ‘‘',
      color: '#667eea',
      lastSeen: 'åˆšåˆšåœ¨çº¿'
    },
    {
      name: 'æœˆå’æ·±é›ª',
      phone: '090-XXXX-0002',
      status: 'online',
      avatar: 'â„ï¸',
      color: '#4299e1',
      lastSeen: '2åˆ†é’Ÿå‰'
    },
    {
      name: 'çŠ¬å†¢å¤ç¾',
      phone: '090-XXXX-0003',
      status: 'busy',
      avatar: 'ğŸ•',
      color: '#ed8936',
      lastSeen: 'è®­ç»ƒä¸­'
    },
    {
      name: 'é˜¿å®…å›',
      phone: '090-XXXX-0004',
      status: 'offline',
      avatar: 'ğŸ‘“',
      color: '#718096',
      lastSeen: 'æ˜¨å¤© 22:30'
    }
  ];

  // ====== åˆå§‹åŒ–å‡½æ•° ======
  document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–æ ‡ç­¾é¡µ
    initTabs();
    
    // åˆå§‹åŒ–é€šè®¯å½•
    initContacts();
    
    // åˆå§‹åŒ–çŸ­ä¿¡åŠŸèƒ½
    initSMS();
    
    // åˆå§‹åŒ–åœ°å›¾ç‚¹å‡»äº‹ä»¶
    initMapMarkers();
    
    console.log('æ‰©å±•é¢æ¿å·²åˆå§‹åŒ–');
  });

  // ====== æ ‡ç­¾é¡µåŠŸèƒ½ ======
  function initTabs() {
    // æ¿€æ´»ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
    switchTab('map');
  }

  function switchTab(tabName) {
    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // æ¿€æ´»å½“å‰æ ‡ç­¾
    const tabBtn = document.querySelector(`.tab-button[onclick*="${tabName}"]`);
    if (tabBtn) {
      tabBtn.classList.add('active');
    }
    
    const tabContent = document.getElementById(`${tabName}-tab`);
    if (tabContent) {
      tabContent.classList.add('active');
    }
    
    currentTab = tabName;
    
    // æ ‡ç­¾é¡µåˆ‡æ¢åçš„é¢å¤–æ“ä½œ
    if (tabName === 'contacts') {
      renderContacts();
    } else if (tabName === 'sms') {
      updateSMSContactInfo();
    }
  }

  // ====== åœ°å›¾åŠŸèƒ½ ======
  function initMapMarkers() {
    document.querySelectorAll('.map-marker').forEach(marker => {
      marker.addEventListener('click', function() {
        const location = this.getAttribute('data-location');
        const description = this.getAttribute('data-description');
        showLocationInfo(location, description);
        
        // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
        const dot = this.querySelector('.marker-dot');
        dot.style.animation = 'pulse 0.3s ease';
        setTimeout(() => {
          dot.style.animation = '';
        }, 300);
      });
    });
  }

  function showLocationInfo(name, description) {
    const infoDiv = document.getElementById('location-info');
    infoDiv.innerHTML = `
      <div class="location-details">
        <div class="location-header">
          <span class="location-icon">ğŸ“</span>
          <h5 style="color: var(--primary-color); font-size: 15px;">${name}</h5>
        </div>
        <p style="font-size: 13px; color: var(--text-secondary); margin: 8px 0;">${description}</p>
        <div class="location-actions" style="display: flex; gap: 10px;">
          <button class="btn-primary" style="padding: 8px 16px; font-size: 12px;" 
                  onclick="travelToLocation('${name}')">
            <span class="btn-icon">ğŸš¶</span>
            å‰å¾€æ­¤å¤„
          </button>
          <button class="btn-secondary" style="padding: 8px 16px; font-size: 12px;"
                  onclick="addToFavorites('${name}')">
            <span class="btn-icon">â­</span>
            æ”¶è—
          </button>
        </div>
      </div>
    `;
  }

  function travelToLocation(locationName) {
    if (window.STInterface && window.STInterface.sendUserMessage) {
      window.STInterface.sendUserMessage(`ï¼ˆç§»åŠ¨åˆ°${locationName}ï¼‰`);
      showNotification(`å·²å‰å¾€${locationName}`, 'success');
    } else {
      console.log(`ç©å®¶ç§»åŠ¨åˆ°: ${locationName}`);
      showNotification(`å·²è®°å½•ä½ç½®: ${locationName}`, 'info');
    }
  }

  function refreshMap() {
    showNotification('åœ°å›¾å·²åˆ·æ–°', 'info');
  }

  function showAllLocations() {
    const locations = [
      { name: 'æ•™å­¦æ¥¼', description: 'äºŒå¹´çº§æ•™å®¤ã€å›¾ä¹¦å®¤ã€ç”µè„‘å®¤' },
      { name: 'ä½“è‚²é¦†', description: 'è¿åŠ¨åœºåœ°ï¼Œæ›´è¡£å®¤å’Œæ·‹æµ´é—´' },
      { name: 'æ—§æ ¡èˆ', description: 'åˆä¼‘é¿éš¾æ‰€ï¼Œå®‰é™å°‘äºº' },
      { name: 'é£Ÿå ‚', description: 'åˆé¤å’Œå°å–éƒ¨æ‰€åœ¨åœ°' },
      { name: 'å›¾ä¹¦é¦†', description: 'å®‰é™çš„å­¦ä¹ åœºæ‰€' }
    ];
    
    let html = '<div style="max-height: 200px; overflow-y: auto;">';
    locations.forEach(loc => {
      html += `
        <div style="padding: 10px; border-bottom: 1px solid var(--border-color);">
          <div style="font-weight: 600; color: var(--primary-color);">${loc.name}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">${loc.description}</div>
        </div>
      `;
    });
    html += '</div>';
    
    showLocationInfo('æ‰€æœ‰åœ°ç‚¹', 'æ ¡å›­å†…çš„æ‰€æœ‰é‡è¦åœ°ç‚¹');
    document.getElementById('location-info').innerHTML = html;
  }

  // ====== é€šè®¯å½•åŠŸèƒ½ ======
  function initContacts() {
    // è®¾ç½®è”ç³»äººæ•°é‡ç»Ÿè®¡
    updateContactStats();
    
    // ç›‘å¬æœç´¢æ¡†
    document.getElementById('contact-search').addEventListener('input', filterContacts);
  }

  function renderContacts(filterText = '') {
    const listDiv = document.getElementById('contacts-list');
    let filteredContacts = contacts;
    
    if (filterText) {
      filteredContacts = contacts.filter(contact => 
        contact.name.toLowerCase().includes(filterText.toLowerCase()) ||
        contact.phone.includes(filterText)
      );
    }
    
    let html = '';
    filteredContacts.forEach(contact => {
      const statusClass = contact.status === 'online' ? 'online' : 
                         contact.status === 'busy' ? 'busy' : 'offline';
      const statusText = contact.status === 'online' ? 'åœ¨çº¿' :
                        contact.status === 'busy' ? 'å¿™ç¢Œ' : 'ç¦»çº¿';
      
      html += `
        <div class="contact-item" onclick="startSMSWith('${contact.name}')">
          <div class="contact-avatar" style="background: linear-gradient(135deg, ${contact.color}, ${contact.color}80);">
            ${contact.avatar}
          </div>
          <div class="contact-info">
            <div class="contact-name">${contact.name}</div>
            <div class="contact-phone">${contact.phone}</div>
            <div class="contact-status">
              <span class="status-dot status-${contact.status}"></span>
              ${statusText} â€¢ ${contact.lastSeen}
            </div>
          </div>
        </div>
      `;
    });
    
    listDiv.innerHTML = html || '<div style="text-align: center; padding: 40px; color: var(--text-muted);">æœªæ‰¾åˆ°è”ç³»äºº</div>';
    updateContactStats();
  }

  function filterContacts() {
    const searchText = document.getElementById('contact-search').value;
    renderContacts(searchText);
  }

  function clearSearch() {
    document.getElementById('contact-search').value = '';
    renderContacts();
  }

  function updateContactStats() {
    const onlineCount = contacts.filter(c => c.status === 'online').length;
    document.getElementById('contact-count').textContent = contacts.length;
    document.getElementById('online-count').textContent = onlineCount;
  }

  // ====== çŸ­ä¿¡åŠŸèƒ½ ======
  function initSMS() {
    // ç›‘å¬çŸ­ä¿¡è¾“å…¥æ¡†
    const smsInput = document.getElementById('sms-input');
    smsInput.addEventListener('input', function() {
      const charCount = this.value.length;
      document.getElementById('char-count').textContent = charCount;
      
      // å­—ç¬¦æ•°è­¦å‘Š
      const counter = document.querySelector('.char-counter');
      if (charCount > 450) {
        counter.style.color = 'var(--warning-color)';
      } else if (charCount > 480) {
        counter.style.color = 'var(--danger-color)';
      } else {
        counter.style.color = 'var(--text-muted)';
      }
    });
    
    // ç›‘å¬è”ç³»äººé€‰æ‹©
    document.getElementById('sms-contact').addEventListener('change', updateSMSContactInfo);
  }

  function updateSMSContactInfo() {
    const select = document.getElementById('sms-contact');
    const contactName = select.value;
    const infoDiv = document.getElementById('recipient-info');
    
    if (contactName) {
      const contact = contacts.find(c => c.name === contactName);
      if (contact) {
        infoDiv.innerHTML = `
          <span class="recipient-status ${contact.status === 'online' ? 'online' : 'offline'}">
            ${contact.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
          </span>
          <span style="color: var(--text-secondary);">${contact.phone}</span>
        `;
      }
    } else {
      infoDiv.innerHTML = '<span class="recipient-status offline">é€‰æ‹©è”ç³»äºº</span>';
    }
  }

  function sendSMS() {
    const select = document.getElementById('sms-contact');
    const input = document.getElementById('sms-input');
    const conversation = document.getElementById('sms-conversation');
    
    const contactName = select.value;
    const message = input.value.trim();
    
    if (!contactName) {
      showNotification('è¯·é€‰æ‹©è”ç³»äºº', 'warning');
      select.focus();
      return;
    }
    
    if (!message) {
      showNotification('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
      input.focus();
      return;
    }
    
    if (message.length > 500) {
      showNotification('æ¶ˆæ¯ä¸èƒ½è¶…è¿‡500å­—', 'warning');
      return;
    }
    
    // åˆ›å»ºå‘é€çš„æ¶ˆæ¯å…ƒç´ 
    const messageElement = document.createElement('div');
    messageElement.className = 'message sent';
    messageElement.innerHTML = `
      <div class="message-avatar">ğŸ˜Š</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-sender">æˆ‘</span>
          <span class="message-time">${getCurrentTime()}</span>
        </div>
        <div class="message-text">${escapeHtml(message)}</div>
      </div>
    `;
    
    conversation.appendChild(messageElement);
    conversation.scrollTop = conversation.scrollHeight;
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    document.getElementById('char-count').textContent = '0';
    
    // å‘é€åˆ°SillyTavern
    sendToSillyTavern(`${contactName}ï¼Œ${message}`);
    
    // æ˜¾ç¤ºå‘é€æˆåŠŸåŠ¨ç”»
    const sendBtn = document.querySelector('.send-btn');
    sendBtn.innerHTML = '<span class="btn-icon">âœ“</span> å·²å‘é€';
    sendBtn.style.background = 'linear-gradient(135deg, var(--success-color), #38a169)';
    
    setTimeout(() => {
      sendBtn.innerHTML = '<span class="send-icon">âœˆï¸</span> å‘é€';
      sendBtn.style.background = 'linear-gradient(135deg, var(--primary-color), var(--secondary-color))';
    }, 2000);
    
    // æ¨¡æ‹Ÿå›å¤ï¼ˆå®é™…ç”±SillyTavernå¤„ç†ï¼‰
    setTimeout(() => {
      const replyElement = document.createElement('div');
      replyElement.className = 'message received';
      replyElement.innerHTML = `
        <div class="message-avatar">${contacts.find(c => c.name === contactName)?.avatar || 'ğŸ‘¤'}</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-sender">${contactName}</span>
            <span class="message-time">${getCurrentTime()}</span>
          </div>
          <div class="message-text">æ­£åœ¨è¾“å…¥...</div>
        </div>
      `;
      conversation.appendChild(replyElement);
      conversation.scrollTop = conversation.scrollHeight;
      
      // æ¨¡æ‹Ÿæ€è€ƒå»¶è¿Ÿ
      setTimeout(() => {
        const replyText = replyElement.querySelector('.message-text');
        if (replyText) {
          replyText.textContent = 'æ”¶åˆ°ä½ çš„æ¶ˆæ¯äº†ï¼Œç¨åå›å¤ä½ ã€‚';
          replyElement.style.animation = 'slideIn 0.3s ease';
        }
      }, 1000);
    }, 1500);
  }

  function startSMSWith(contactName) {
    // åˆ‡æ¢åˆ°çŸ­ä¿¡æ ‡ç­¾é¡µ
    switchTab('sms');
    
    // è®¾ç½®è”ç³»äºº
    setTimeout(() => {
      const select = document.getElementById('sms-contact');
      select.value = contactName;
      updateSMSContactInfo();
      document.getElementById('sms-input').focus();
    }, 100);
  }

  function addEmoji() {
    const input = document.getElementById('sms-input');
    const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤”', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'âœ¨', 'ğŸŒŸ'];
    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
    
    input.value += randomEmoji;
    input.focus();
    input.dispatchEvent(new Event('input'));
    
    showNotification(`æ·»åŠ äº†è¡¨æƒ… ${randomEmoji}`, 'info');
  }

  function attachFile() {
    showNotification('æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­', 'info');
  }

  // ====== å·¥å…·å‡½æ•° ======
  function getCurrentTime() {
    const now = new Date();
    return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showNotification(message, type = 'info') {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: ${type === 'success' ? '#48bb78' : type === 'warning' ? '#ed8936' : type === 'error' ? '#f56565' : '#4299e1'};
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      z-index: 10001;
      animation: slideIn 0.3s ease;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    `;
    
    notification.innerHTML = `
      <span style="font-size: 16px;">${type === 'success' ? 'âœ“' : type === 'warning' ? 'âš ' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
      <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åç§»é™¤
    setTimeout(() => {
      notification.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }

  function addToFavorites(locationName) {
    showNotification(`å·²æ”¶è—åœ°ç‚¹: ${locationName}`, 'success');
  }

  function closeExtension() {
    // è¿™ä¸ªå‡½æ•°ä¼šè¢«çˆ¶é¡µé¢è°ƒç”¨
    if (parent && parent.document.getElementById('hypnosis-extension-iframe')) {
      parent.document.getElementById('hypnosis-extension-iframe').style.display = 'none';
    }
  }

  function sendToSillyTavern(message) {
    // ä¸SillyTaverné€šä¿¡
    if (window.STInterface && window.STInterface.sendUserMessage) {
      window.STInterface.sendUserMessage(message);
    } else if (parent && parent.STInterface) {
      parent.STInterface.sendUserMessage(message);
    } else {
      console.log('[SMSå‘é€åˆ°ST]:', message);
      showNotification('æ¶ˆæ¯å·²è®°å½•ï¼Œä½†STé›†æˆæœªå®Œå…¨åŠ è½½', 'warning');
    }
  }

  // åˆå§‹åŒ–æ¸²æŸ“
  setTimeout(() => {
    renderContacts();
    console.log('ç¾åŒ–ç•Œé¢å·²åŠ è½½å®Œæˆ');
  }, 100);
</script>
