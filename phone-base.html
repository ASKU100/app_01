<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºåŠŸèƒ½</title>
    <style>
        /* é‡ç½®å’ŒåŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* æ‚¬æµ®çƒæ ·å¼ */
        #phone-floating-ball {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        #phone-floating-ball:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        #phone-floating-ball.active {
            transform: rotate(45deg) scale(1.1);
        }
        
        .phone-icon {
            color: white;
            font-size: 28px;
            font-weight: bold;
        }
        
        /* åŠŸèƒ½é¢æ¿ */
        #phone-panel {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: none;
            z-index: 9999;
        }
        
        #phone-panel.active {
            display: block;
        }
        
        /* é€‰é¡¹å¡ */
        .phone-tabs {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .phone-tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .phone-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .phone-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 3px solid white;
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .phone-content {
            height: calc(100% - 50px);
            overflow: hidden;
        }
        
        .phone-tab-content {
            height: 100%;
            display: none;
            overflow-y: auto;
        }
        
        .phone-tab-content.active {
            display: block;
        }
        
        /* åœ°å›¾æ ·å¼ */
        .map-container {
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            background: #f8f9fa;
            min-height: 100%;
        }
        
        .map-location {
            margin-left: 15px;
        }
        
        .map-location.highlight {
            color: #667eea;
            font-weight: bold;
        }
        
        /* é€šè®¯å½•æ ·å¼ */
        .contacts-container {
            padding: 20px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .contact-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            font-weight: 600;
            color: #333;
        }
        
        .contact-relation {
            font-size: 12px;
            color: #6c757d;
        }
        
        /* çŸ­ä¿¡æ ·å¼ */
        .sms-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }
        
        .sms-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .sms-message {
            max-width: 80%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .sms-sent {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .sms-received {
            background: #e9ecef;
            color: #333;
            align-self: flex-start;
        }
        
        .sms-input-area {
            display: flex;
            gap: 10px;
        }
        
        .sms-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .sms-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .sms-send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            #phone-panel {
                width: 90vw;
                right: 5vw;
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- æ‚¬æµ®çƒ -->
    <div id="phone-floating-ball">
        <div class="phone-icon">ğŸ“±</div>
    </div>
    
    <!-- åŠŸèƒ½é¢æ¿ -->
    <div id="phone-panel">
        <!-- é€‰é¡¹å¡ -->
        <div class="phone-tabs">
            <button class="phone-tab active" data-tab="map">ğŸ—ºï¸ åœ°å›¾</button>
            <button class="phone-tab" data-tab="contacts">ğŸ‘¥ é€šè®¯å½•</button>
            <button class="phone-tab" data-tab="sms">ğŸ’¬ çŸ­ä¿¡</button>
        </div>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="phone-content">
            <!-- åœ°å›¾ -->
            <div class="phone-tab-content active" id="map-content">
                <div class="map-container" id="map-display">
                    <!-- åœ°å›¾å†…å®¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- é€šè®¯å½• -->
            <div class="phone-tab-content" id="contacts-content">
                <div class="contacts-container" id="contacts-list">
                    <!-- è”ç³»äººåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- çŸ­ä¿¡ -->
            <div class="phone-tab-content" id="sms-content">
                <div class="sms-container">
                    <div class="sms-history" id="sms-history">
                        <div style="text-align: center; color: #6c757d; padding: 30px;">
                            é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©
                        </div>
                    </div>
                    <div class="sms-input-area">
                        <input type="text" class="sms-input" id="sms-input" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
                        <button class="sms-send-btn" id="sms-send-btn" disabled>â†‘</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ç®€åŒ–ç‰ˆæ‰‹æœºåŠŸèƒ½
        (function() {
            'use strict';
            
            console.log('[æ‰‹æœºåŠŸèƒ½] åˆå§‹åŒ–');
            
            // DOMå…ƒç´ 
            const floatingBall = document.getElementById('phone-floating-ball');
            const panel = document.getElementById('phone-panel');
            const tabs = document.querySelectorAll('.phone-tab');
            const tabContents = document.querySelectorAll('.phone-tab-content');
            
            // å½“å‰çŠ¶æ€
            let currentTab = 'map';
            let currentContact = null;
            let contacts = [];
            
            // åˆå§‹åŒ–
            function init() {
                // æ‚¬æµ®çƒç‚¹å‡»äº‹ä»¶
                floatingBall.addEventListener('click', togglePanel);
                
                // é€‰é¡¹å¡ç‚¹å‡»äº‹ä»¶
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.getAttribute('data-tab');
                        switchTab(tabName);
                    });
                });
                
                // çŸ­ä¿¡å‘é€äº‹ä»¶
                document.getElementById('sms-send-btn').addEventListener('click', sendMessage);
                document.getElementById('sms-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                
                // åˆå§‹åŠ è½½åœ°å›¾
                loadMap();
                
                // å°è¯•åŠ è½½è”ç³»äºº
                setTimeout(loadContacts, 1000);
                
                console.log('[æ‰‹æœºåŠŸèƒ½] åˆå§‹åŒ–å®Œæˆ');
            }
            
            // åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
            function togglePanel() {
                panel.classList.toggle('active');
                floatingBall.classList.toggle('active');
                
                if (panel.classList.contains('active')) {
                    // é¢æ¿æ‰“å¼€æ—¶åˆ·æ–°å½“å‰æ ‡ç­¾å†…å®¹
                    refreshCurrentTab();
                }
            }
            
            // åˆ‡æ¢é€‰é¡¹å¡
            function switchTab(tabName) {
                // æ›´æ–°é€‰é¡¹å¡
                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName);
                });
                
                // æ›´æ–°å†…å®¹
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}-content`);
                });
                
                currentTab = tabName;
                refreshCurrentTab();
            }
            
            // åˆ·æ–°å½“å‰é€‰é¡¹å¡å†…å®¹
            function refreshCurrentTab() {
                switch(currentTab) {
                    case 'map':
                        loadMap();
                        break;
                    case 'contacts':
                        loadContacts();
                        break;
                    case 'sms':
                        loadSMS();
                        break;
                }
            }
            
            // åŠ è½½åœ°å›¾
            function loadMap() {
                const mapDisplay = document.getElementById('map-display');
                
                const mapData = `
ä¸œäº¬æ•´ä½“ä½ç½®å…³ç³»
è¥¿åŒ—æ–¹å‘
â”œâ”€ æ‰å¹¶åŒºï¼ˆæ•…äº‹ä¸»è¦èˆå°ï¼‰
â”‚   â”œâ”€ é«˜å††å¯ºï¼ˆä¸»è§’ã€ä¼Šè‰é›…ã€ç¾æ¸¸ã€å…‹æ´›ä¼Šã€å­¦æ ¡ï¼‰
â”‚   â”œâ”€ é˜¿ä½è°·ï¼ˆçŠ¬å†¢å¤ç¾ï¼‰
â”‚   â””â”€ è»æ´¼ï¼ˆå‘¨è¾¹å•†ä¸šåŒºï¼‰
â”‚
â”œâ”€ ä¸­é‡åŒºï¼ˆé˜¿å®…å›ï¼‰
â”‚
â”œâ”€ æ–°å®¿åŒºï¼ˆç¹åå•†ä¸šåŒºï¼Œè½¬è½¦æ¢çº½ï¼‰
â”‚
â”œâ”€ æ–‡äº¬åŒºï¼ˆæœˆå’æ·±é›ªï¼‰
â”‚
â””â”€ æ¸¯åŒºï¼ˆè¥¿å›­å¯ºçˆ±ä¸½èï¼‰

å½“å‰åœ°ç‚¹ï¼šç§ç«‹æ–‹æ˜å­¦å›­ï¼ˆé«˜å††å¯ºï¼‰
ä¸»è¦è§’è‰²åˆ†å¸ƒï¼š
â€¢ è¥¿å›­å¯ºçˆ±ä¸½è - æ¸¯åŒº
â€¢ æœˆå’æ·±é›ª - æ–‡äº¬åŒº
â€¢ çŠ¬å†¢å¤ç¾ - é˜¿ä½è°·
â€¢ é˜¿å®…å› - ä¸­é‡åŒº
                `;
                
                mapDisplay.innerHTML = `<pre style="white-space: pre-wrap; margin: 0;">${mapData.trim()}</pre>`;
            }
            
            // åŠ è½½è”ç³»äºº
            function loadContacts() {
                const contactsList = document.getElementById('contacts-list');
                
                // å°è¯•ä»MVUè·å–è”ç³»äººæ•°æ®
                const defaultContacts = [
                    { name: 'è¥¿å›­å¯ºçˆ±ä¸½è', relation: 'è¥¿å›­å¯ºè´¢å›¢åƒé‡‘', initial: 'è¥¿' },
                    { name: 'æœˆå’æ·±é›ª', relation: 'ç­çº§å§”å‘˜é•¿', initial: 'æœˆ' },
                    { name: 'çŠ¬å†¢å¤ç¾', relation: 'ç”°å¾„éƒ¨ç‹ç‰Œ', initial: 'çŠ¬' },
                    { name: 'é˜¿å®…å›', relation: 'åŒå­¦', initial: 'é˜¿' }
                ];
                
                contacts = defaultContacts;
                
                const contactsHTML = contacts.map(contact => `
                    <div class="contact-item" data-contact="${contact.name}">
                        <div class="contact-avatar">${contact.initial}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="contact-relation">${contact.relation}</div>
                        </div>
                    </div>
                `).join('');
                
                contactsList.innerHTML = contactsHTML;
                
                // æ·»åŠ è”ç³»äººç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.contact-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const contactName = this.getAttribute('data-contact');
                        startSMS(contactName);
                    });
                });
            }
            
            // å¼€å§‹çŸ­ä¿¡èŠå¤©
            function startSMS(contactName) {
                currentContact = contactName;
                switchTab('sms');
                
                // æ›´æ–°ç•Œé¢
                const input = document.getElementById('sms-input');
                const sendBtn = document.getElementById('sms-send-btn');
                
                input.placeholder = `å‘é€ç»™ ${contactName}...`;
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
                
                // æ˜¾ç¤ºèŠå¤©å†å²
                showSMSHistory(contactName);
            }
            
            // æ˜¾ç¤ºçŸ­ä¿¡å†å²
            function showSMSHistory(contactName) {
                const history = document.getElementById('sms-history');
                
                // ä»localStorageè·å–å†å²è®°å½•
                const storageKey = `sms_${contactName}`;
                const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                if (messages.length === 0) {
                    history.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 30px;">
                            å¼€å§‹å’Œ ${contactName} èŠå¤©
                        </div>
                    `;
                    return;
                }
                
                const historyHTML = messages.map(msg => `
                    <div class="sms-message ${msg.type === 'sent' ? 'sms-sent' : 'sms-received'}">
                        ${msg.content}
                        <div style="font-size: 11px; color: #6c757d; margin-top: 4px; text-align: ${msg.type === 'sent' ? 'right' : 'left'};">${msg.time}</div>
                    </div>
                `).join('');
                
                history.innerHTML = historyHTML;
                history.scrollTop = history.scrollHeight;
            }
            
            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const input = document.getElementById('sms-input');
                const message = input.value.trim();
                
                if (!message || !currentContact) {
                    return;
                }
                
                // ä¿å­˜åˆ°å†å²è®°å½•
                const storageKey = `sms_${currentContact}`;
                const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                const newMessage = {
                    content: message,
                    time: getCurrentTime(),
                    type: 'sent'
                };
                
                messages.push(newMessage);
                localStorage.setItem(storageKey, JSON.stringify(messages));
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                const history = document.getElementById('sms-history');
                const messageHTML = `
                    <div class="sms-message sms-sent">
                        ${message}
                        <div style="font-size: 11px; color: #6c757d; margin-top: 4px; text-align: right;">${getCurrentTime()}</div>
                    </div>
                `;
                
                history.innerHTML += messageHTML;
                history.scrollTop = history.scrollHeight;
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                input.focus();
                
                // å‘é€åˆ°AIï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„èŠå¤©ç•Œé¢è°ƒæ•´ï¼‰
                sendToAI(currentContact, message);
                
                // æ˜¾ç¤ºå¯¹æ–¹æ­£åœ¨è¾“å…¥
                showTypingIndicator();
            }
            
            // å‘é€æ¶ˆæ¯åˆ°AI
            function sendToAI(contactName, message) {
                // è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„èŠå¤©ç•Œé¢è°ƒæ•´
                // é€šå¸¸æ˜¯é€šè¿‡æŸ¥æ‰¾è¾“å…¥æ¡†å¹¶æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥
                console.log(`å‘é€æ¶ˆæ¯ç»™ ${contactName}: ${message}`);
                
                // å°è¯•æ‰¾åˆ°èŠå¤©è¾“å…¥æ¡†
                const chatInputs = [
                    document.querySelector('#user-input'),
                    document.querySelector('textarea'),
                    document.querySelector('input[type="text"]')
                ].filter(el => el);
                
                if (chatInputs.length > 0) {
                    const input = chatInputs[0];
                    input.value = `ï¼ˆå‘é€çŸ­ä¿¡ç»™${contactName}ï¼š${message}ï¼‰`;
                    
                    // è§¦å‘è¾“å…¥äº‹ä»¶
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // å°è¯•å‘é€ï¼ˆéœ€è¦æ ¹æ®å…·ä½“ç•Œé¢è°ƒæ•´ï¼‰
                    setTimeout(() => {
                        // æŸ¥æ‰¾å‘é€æŒ‰é’®æˆ–æŒ‰å›è½¦
                        const sendButtons = [
                            document.querySelector('button[aria-label*="å‘é€"]'),
                            document.querySelector('button:contains("å‘é€")')
                        ].filter(el => el);
                        
                        if (sendButtons.length > 0) {
                            sendButtons[0].click();
                        } else {
                            // å°è¯•å›è½¦å‘é€
                            input.dispatchEvent(new KeyboardEvent('keydown', {
                                key: 'Enter',
                                code: 'Enter',
                                keyCode: 13,
                                bubbles: true
                            }));
                        }
                    }, 100);
                }
            }
            
            // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
            function showTypingIndicator() {
                const history = document.getElementById('sms-history');
                const indicator = `
                    <div class="sms-message sms-received" id="typing-indicator">
                        <div style="display: flex; gap: 4px;">
                            <div style="width: 8px; height: 8px; background: #6c757d; border-radius: 50%; animation: typing 1.4s infinite;"></div>
                            <div style="width: 8px; height: 8px; background: #6c757d; border-radius: 50%; animation: typing 1.4s 0.2s infinite;"></div>
                            <div style="width: 8px; height: 8px; background: #6c757d; border-radius: 50%; animation: typing 1.4s 0.4s infinite;"></div>
                        </div>
                        <style>
                            @keyframes typing {
                                0%, 60%, 100% { opacity: 0.4; transform: translateY(0); }
                                30% { opacity: 1; transform: translateY(-5px); }
                            }
                        </style>
                    </div>
                `;
                
                history.innerHTML += indicator;
                history.scrollTop = history.scrollHeight;
            }
            
            // æ¥æ”¶AIå›å¤
            window.receiveSMSReply = function(contactName, message) {
                if (currentContact === contactName) {
                    // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                    const indicator = document.getElementById('typing-indicator');
                    if (indicator) indicator.remove();
                    
                    // ä¿å­˜å›å¤
                    const storageKey = `sms_${contactName}`;
                    const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    messages.push({
                        content: message,
                        time: getCurrentTime(),
                        type: 'received'
                    });
                    
                    localStorage.setItem(storageKey, JSON.stringify(messages));
                    
                    // æ˜¾ç¤ºå›å¤
                    const history = document.getElementById('sms-history');
                    const replyHTML = `
                        <div class="sms-message sms-received">
                            ${message}
                            <div style="font-size: 11px; color: #6c757d; margin-top: 4px;">${getCurrentTime()}</div>
                        </div>
                    `;
                    
                    history.innerHTML += replyHTML;
                    history.scrollTop = history.scrollHeight;
                }
            };
            
            // è·å–å½“å‰æ—¶é—´
            function getCurrentTime() {
                const now = new Date();
                return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // åŠ è½½çŸ­ä¿¡
            function loadSMS() {
                if (currentContact) {
                    showSMSHistory(currentContact);
                }
            }
            
            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();
    </script>
</body>
</html>
